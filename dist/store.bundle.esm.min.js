var v=class{events={};on(t,e){typeof this.events[t]!="object"&&(this.events[t]=[]),this.events[t].push(e);let s=this;return function(){s.removeListener(t,e)}}removeListener(t,e){var s;typeof this.events[t]=="object"&&(s=this.events[t].indexOf(e),s>-1&&this.events[t].splice(s,1))}emit(t){if(typeof this.events[t]=="object"){var e,s,r,i=[].slice.call(arguments,1);for(s=this.events[t].slice(),r=s.length,e=0;e<r;e++)try{s[e].apply(this,i)}catch(l){console.error(t,i),console.error(l)}}}once(t,e){return this.on(t,function s(){this.removeListener(t,s),e.apply(this,arguments)})}};var c=class{#e;#t;constructor(t,e,s){this.#t=t,this.#e=e,typeof s<"u"&&(this.value=s)}set value(t){this.#t.setItem(this.#e,t)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(t,e){return this.#t.subscribe(this.#e,t,e)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}setCompareFunction(t){return this.#t.setCompareFunction(this.#e,t)}get store(){return this.#t}};var d=class{#e;#t;constructor(t,e,s){this.#t=t,this.#e=e,typeof s<"u"&&this.#t.createCollectionItem(this.#e,s)}set value(t){this.#t.setItem(this.#e,t)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(t,e){return this.#t.subscribe(this.#e,t,e)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}get store(){return this.#t}};var g=class{#e;#t;constructor(t,e,s){this.#t=t,this.#e=e,typeof s<"u"&&this.#t.createComputedItem(this.#e,s)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(t,e){return this.#t.subscribe(this.#e,t,e)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}recalc(){return this.#t.recalcComputed(this.#e)}get store(){return this.#t}};function b(o,t){if(o===t)return!0;if(o===null||t===null||o===void 0||t===void 0||typeof o!=typeof t)return!1;if(Array.isArray(o)||Array.isArray(t))return JSON.stringify(o)===JSON.stringify(t);let e=JSON.stringify(o,Object.keys(o).sort()),s=JSON.stringify(t,Object.keys(t).sort());return e===s}function y(o,t){var e,s=(...r)=>{var i=this,l=function(){e=null,o.apply(i,r)};clearTimeout(e),e=setTimeout(l,t)};return s}function C(o){return typeof o=="object"&&!Array.isArray(o)&&o!==null}var a=class{value;old_value;item_name;eventType;property=null},A=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,I=class{#e=new Map;#t=new Map;#s=new Map;#g=new Map;#p=null;#n={};#o=!1;#l=!1;#f=[];#y=0;#r=new v;#u=!1;#h=new Set;#v=0;log=console.log;logError=console.error;warn=console.warn;constructor(t){if(t)for(let e in t){let s=t[e];if(s==null){this.#c(e,s);continue}if(Array.isArray(s)){this.createCollection(s,e);continue}s instanceof Function||this.#c(e,s)}}#b(t){return A.test(t)}#C(t,e){let s=this.#e.get(t);this.#e.set(t,e);let r=!0;if(this.#n[t]?r=this.#n[t](s,e,t,null):r=b(s,e),!r){let i=new a;return i.eventType="set",i.item_name=t,i.value=e,i.old_value=s,this.#i(t,i),i}return!1}#c(t,e){if(!this.#b(t))throw new Error(`${t} is wrong store's item_name`);this.#e.set(t,e)}#m(t,e,s){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");e=e.toString();let r=this.#s.get(t)||[],i=r[e],l=!0;if(this.#n[t]?l=this.#n[t](i,s,t,e):l=b(i,s),l)return!1;r[e]=s;let n=new a;return n.eventType="set",n.item_name=t,n.property=e,n.value=s,n.old_value=i,this.#i(t,n),n}#A(t,e){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");e=e.toString();let s=this.#s.get(t);if(s===void 0)throw new Error(`#deleteCollectionItem error: ${t}`);let r=s[e];delete s[e];let i=new a;return i.eventType="delete",i.item_name=t,i.property=e,i.value=null,i.old_value=r,this.#i(t,i),i}#E(t,e){Array.isArray(e)||(this.warn(`Cannot assign a non-array value to a collection. Now ${t} == [].`),e=[]);let s=this.#s.get(t)||[],r=!0,i=s.length;if(i!=e.length){let n=new a;n.eventType="set",n.item_name=t,n.property="length",n.value=e.length,n.old_value=i,this.#i(t,n)}if(s.length>e.length)for(let n=e.length;n<s.length;n++)this.#A(t,(s.length-n-1).toString())&&(r=!1);s.length=e.length;for(let n=0;n<e.length;n++)this.#m(t,n.toString(),e[n])&&(r=!1);if(r)return!1;let l=new a;return l.eventType="set",l.item_name=t,l.value=e,l.old_value=void 0,this.#i(t,l),this.#d([t]),l}hasItem(t){return t=="store"||this.#e.has(t)||this.#t.has(t)||this.#s.has(t)}setItem(t,e){var s={[t]:e};this.setItems(s)}#d(t){var e=new Set;for(let s=0;s<t.length;s++)e.add(t[s]);this.#t.forEach(s=>{!this.#O(s,e)||!this.hasSubscribers(s.item_name)||this.#w(s.item_name)})}setItems(t){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var e=[];for(let s in t){if(s=="store"||this.isComputedItem(s))continue;if(!this.hasItem(s)){if(this.#o){this.logError(`Store is sealed. Can't create the item "${s}"`);continue}this.#c(s,void 0)}let r=t[s],i;this.isAtomItem(s)&&(i=this.#C(s,r)),this.isCollection(s)&&(i=this.#E(s,r)),i&&e.push(s)}this.#d(e),this.#a()}isComputedItem(t){return this.#t.has(t)}isAtomItem(t){return this.#e.has(t)}isCollection(t){return this.#s.has(t)}#w(t){let e=this.#t.get(t);if(e===void 0)throw new Error(`#recalc error: ${t}`);let s=e.value;e.stale=!0;let r=e.getter();e.stale=!1;let i=!0;if(this.#n[t]?i=this.#n[t](s,r,t,null):i=b(s,r),i)return!1;e.value=r;let l=new a;return l.eventType="set",l.item_name=t,l.value=r,l.old_value=s,this.#i(t,l),l}recalcComputed(t){if(!this.isComputedItem(t))return!1;let e=this.#w(t);return e&&this.#a(),e}#j(t,e){let s=this;var r=()=>{try{return e(s)}catch(h){return this.logError(`Computed error ${t}: `,h),"#ERROR!"}},i=this.getUsedItems(r),l=i.value,n=i.items.filter(h=>this.isAtomItem(h)||this.isCollection(h));if(n.length==0)throw new Error(`Computed item ${t} hasn't dependencies`);this.#t.set(t,{item_name:t,dependencies:n,getter:r,value:l,stale:!1})}#O(t,e){for(var s=t.dependencies,r=0;r<s.length;r++)if(e.has(s[r]))return t.stale=!0,!0;return!1}#S(t,e,s=!1){if(t=t.trim(),this.hasItem(t))return this.warn(`Item name ${t} name already exists`),!1;if(!s&&!this.#b(t))throw new Error(`${t} is wrong store's item_name`);return this.#j(t,e),!0}createComputedItem(t,e){return this.#o?(this.logError(`Store is sealed. Can't create the item "${t}"`),!1):this.#S(t,e)}loadExpression(t){t=t.trim();let e=`{${t}}`;if(this.hasItem(e))return e;var s=new Set,r=t,i=r.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let u of i){let p=u[0].slice(1);this.hasItem(p)&&s.add(p)}var l=Array.from(s),n=l.map(u=>`var $${u} = store.getItem("${u}");`).join(`
`),h=new Function("store",`
    ${n}
    return ${t};
`);return this.#S(e,h,l,!0),e}createCollectionItem(t,e){t=t.trim();var s=e.length;if(this.hasItem(t))throw new Error(`Item name ${t} name already exists`);if(!this.#b(t))throw new Error(`${t} is wrong store's item_name`);var r=this,i=new Proxy(e,{deleteProperty:function(l,n){let h=l.length;return typeof n=="symbol"?delete l[n]:typeof n=="string"&&r.#A(t,n)&&(delete l[n],r.#d([t]),r.#a()),!0},set:function(l,n,h,u){if(typeof n=="symbol")l[n]=h;else if(typeof n=="string"){let p=r.#s.get(t)||[],w=parseInt(n),m=p.length;if(!isNaN(w)&&w>=p.length){let f=new a;f.eventType="set",f.item_name=t,f.property="length",f.value=w+1,f.old_value=m,r.#i(t,f)}r.#m(t,n,h)&&(l[n]=h,r.#d([t]),r.#a())}return!0}});return r.#s.set(t,e),r.#g.set(t,i),i}onChange(t){return this.#r.on("#change",t)}onChangeAny(t,e){let s=[];for(let l=0;l<t.length;l++){let n=t[l];if(typeof n=="string"){this.hasItem(n)&&s.push(n);continue}(n instanceof c||n instanceof g||n instanceof d)&&n.store===this&&s.push(n.name)}if(s.length==0)return;let r=this;return this.#r.on("#change",function(l){let n=!1,h={};for(let u in l)if(s.indexOf(u)>-1){n=!0,h[u]=l[u];break}n&&e(h,r)})}deleteItem(t){if(this.#o)return this.logError(`Store is sealed. Can't delete the item "${t}"`),!1;if(!this.hasItem(t))return!1;let e=this.getItem(t),s=new a;return s.eventType="delete",s.item_name=t,s.value=e,this.clearItemSubscribers(t),this.isComputedItem(t)&&this.#t.delete(t),this.isAtomItem(t)&&this.#e.delete(t),this.isCollection(t)&&(this.#s.delete(t),this.#g.delete(t)),this.#i(t,s),this.#a(),!0}#$(){return Object.fromEntries(this.#e)}getItems(t=!1){return t?Object.assign({},this.#$(),this.#U()):this.#$()}#x(t){this.#u&&this.#h.add(t);let e=this.#t.get(t);if(e===void 0)throw new Error(`#getComputedValue error: ${t}`);e.stale&&this.#w(t);let s=this.#t.get(t);if(s===void 0)throw new Error(`#getComputedValue error: ${t}`);return s.value}#T(t){return this.#u&&this.#h.add(t),this.#g.get(t)}#U(){let t={};return this.#t.forEach(e=>{t[e.item_name]=this.#x(e.item_name)}),t}#N(t){return this.#u&&this.#h.add(t),this.#e.get(t)}getItem(t){if(t=="store")return this;if(this.hasItem(t)){if(this.isAtomItem(t))return this.#N(t);if(this.isComputedItem(t))return this.#x(t);if(this.isCollection(t))return this.#T(t)}}getItemNames(){let t=[];return this.#e.forEach((e,s)=>{t.push(s)}),this.#t.forEach((e,s)=>{t.push(s)}),this.#s.forEach((e,s)=>{t.push(s)}),t}subscribe(t,e,s){s===void 0&&(s=this.#y);var r=s<=0?e:y(e,s);return this.#r.on(t,r)}hasSubscribers(t){let e=this.#r.events[t];return e?e.length>0:!1}clearSubscribers(){this.#r.events={}}clearItemSubscribers(t){delete this.#r.events[t]}reset(){this.#e.clear(),this.#t.clear(),this.#s.clear(),this.clearSubscribers()}asObject(){return this.#p||(this.#p=this.#k()),this.#p}#k(){let t={},e=this,s={get(r,i){return typeof i=="string"?e.getItem(i):null},set(r,i,l){return e.setItems({[i]:l}),!0},ownKeys(r){return e.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,i){return typeof i=="string"&&e.deleteItem(i),!0}};return new Proxy(t,s)}setCompareFunction(t,e){return this.hasItem(t)?(this.#n[t]=e,!0):!1}isSealed(){return this.#o}seal(){this.#o=!0}unseal(){this.#o=!1}#i(t,e){this.#f.push([t,e])}#a(){if(!this.#l){this.#l=!0;for(var t={},e=0;e<this.#f.length;){let s=this.#f[e];this.#r.emit(s[0],s[1],this),e++,t[s[0]]||(t[s[0]]=[]),t[s[0]].push(s[1])}this.#r.emit("#change",t,this),this.#f=[],this.#l=!1,this.#r.emit("#reactions_finished",this)}}setDebounceTime(t){this.#y=t<0?0:t}next(t){this.#l?this.#r.once("#reactions_finished",t):t(this)}#I(){for(;this.hasItem("_"+this.#v);)this.#v++;return"_"+this.#v}createAtom(t,e){return typeof e>"u"&&(e=this.#I()),new c(this,e,t)}getAtom(t){if(this.isAtomItem(t))return new c(this,t);throw new Error(`Unknown atom ${t}`)}createComputed(t,e){return typeof e>"u"&&(e=this.#I()),new g(this,e,t)}getComputed(t){if(this.isComputedItem(t))return new g(this,t);throw new Error(`Unknown computed ${t}`)}createCollection(t,e){return typeof e>"u"&&(e=this.#I()),new d(this,e,t)}getCollection(t){if(this.isCollection(t))return new d(this,t);throw new Error(`Unknown collection ${t}`)}observeObject(t){if(!C(t))throw new Error(`obj must have an object type. obj = ${t}`);let e=this,s={store:{get(){return e}}};for(let r in t){let i=t[r];if(i instanceof Function||typeof i=="symbol"||(s[r]={get(){return e.getItem(r)},set(l){e.setItem(r,l)}}),this.hasItem(r)){if(this.isCollection(r)){let l=Array.isArray(i)?i:[];this.#E(r,l);continue}if(this.isAtomItem(r)){this.#C(r,i);continue}}else{if(Array.isArray(i)){this.createCollectionItem(r,i);continue}if(i instanceof Function||typeof i=="symbol")continue;this.#c(r,i);continue}}return Object.defineProperties(t,s),t}getUsedItems(t){this.#h.clear(),this.#u=!0;let e=t();var s=Array.from(this.#h);return this.#u=!1,this.#h.clear(),{value:e,items:s}}autorun(t){var e=this.getUsedItems(t);if(e.items.length>0)return this.onChangeAny(e.items,t)}reaction(t,e){var s=this.getUsedItems(t);if(s.items.length>0)return this.onChangeAny(s.items,e)}when(t,e){var s=this.getUsedItems(t);return e?this.onChangeAny(s.items,()=>{try{t()&&e()}catch(r){this.logError(r)}}):new Promise((r,i)=>{var l=this.onChangeAny(s.items,()=>{let n=t();n&&(l&&l(),r(n))})})}};function K(o){return new I(o)}export{v as EventEmitter,I as Store,a as UpdateEventDetails,K as createStore,y as debounce};
