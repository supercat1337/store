var w=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,r,n=[].slice.call(arguments,1);for(s=this.events[e].slice(),r=s.length,t=0;t<r;t++)try{s[t].apply(this,n)}catch(i){console.error(e,n),console.error(i)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};var b=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,this.value=s}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}setCompareFunction(e){return this.#e.setCompareFunction(this.#t,e)}get store(){return this.#e}onHasSubscribers(e){return this.#e.onHasSubscribers(this.#t,e)}onNoSubscribers(e){return this.#e.onNoSubscribers(this.#t,e)}};function I(u,e){if(u===e)return!0;if(u===null||e===null||u===void 0||e===void 0||typeof u!=typeof e)return!1;if(Array.isArray(u)||Array.isArray(e))return JSON.stringify(u)===JSON.stringify(e);let t=JSON.stringify(u,Object.keys(u).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function m(u,e){var t,s=(...r)=>{var n=this,i=function(){t=null,u.apply(n,r)};clearTimeout(t),t=setTimeout(i,e)};return s}function y(u){return typeof u=="object"&&!Array.isArray(u)&&u!==null}function E(u){var e=new Set;for(let t=0;t<u.length;t++)e.add(u[t]);return e}var g=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createCollectionItem(this.#t,s)}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}set content(e){this.#e.setItem(this.#t,e)}get content(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}get store(){return this.#e}updateItemValue(e,t){var s=this.#e.getItem(this.#t),r;y(s[e])?r={...s[e],...t}:r=t,s[e]=r}onHasSubscribers(e){return this.#e.onHasSubscribers(this.#t,e)}onNoSubscribers(e){return this.#e.onNoSubscribers(this.#t,e)}};var p=class{#t;#e;constructor(e,t,s,r={}){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createComputedItem(this.#t,s,r)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}recalc(){return this.#e.recalcComputed(this.#t)}get store(){return this.#e}onHasSubscribers(e){return this.#e.onHasSubscribers(this.#t,e)}onNoSubscribers(e){return this.#e.onNoSubscribers(this.#t,e)}};var f=class{value;old_value;item_name;eventType;property=null},A=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,C=class{#t=new Map;#e=new Map;#r=new Map;#v=new Map;#b=null;#n={};#l=!1;#o=!1;#c=[];#C=0;#s=new w;#h=!1;#u=new Set;#g=0;log=console.log;logError=console.error;warn=console.warn;constructor(e){if(e)for(let t in e){let s=e[t];if(s==null){this.#f(t,s);continue}if(Array.isArray(s)){this.createCollection(s,t);continue}s instanceof Function||this.#f(t,s)}}#p(e){return A.test(e)}#S(e,t){var s=0,r=void 0,n=this.#t.get(e)||{version:0,value:void 0};n&&(s=n.version,r=n.value);let i=!0;if(this.#n[e]?i=this.#n[e](r,t,e,null):i=I(r,t),!i){n.value=t,n.version++,this.#t.set(e,n);let o=new f;return o.eventType="set",o.item_name=e,o.value=t,o.old_value=r,this.#i(e,o),o}return!1}#f(e,t){if(!this.#p(e))throw new Error(`${e} is wrong store's item_name`);var s={version:0,value:t};this.#t.set(e,s)}#m(e,t,s){if(this.#o)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();var r=this.#r.get(e)||{value:[],version:0};let n=r.value,i=n[t],o=!0;if(this.#n[e]?o=this.#n[e](i,s,e,t):o=I(i,s),o)return!1;n[t]=s;let l=new f;return l.eventType="set",l.item_name=e,l.property=t,l.value=s,l.old_value=i,r.version++,this.#i(e,l),l}#E(e,t){if(this.#o)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();var s=this.#r.get(e)||{value:[],version:0},r=s.value;if(r===void 0)throw new Error(`#deleteCollectionItem error: ${e}`);var n=r[t];delete r[t];var i=new f;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=n,s.version++,this.#i(e,i),i}#A(e,t){Array.isArray(t)||(this.warn(`Cannot assign a non-array value to a collection. Now ${e} == [].`),t=[]);var s=this.#r.get(e)||{value:[],version:0},r=s.value,n=!0,i=r.length;if(i!=t.length){let l=new f;l.eventType="set",l.item_name=e,l.property="length",l.value=t.length,l.old_value=i,s.version++,this.#i(e,l)}if(r.length>t.length)for(let l=t.length;l<r.length;l++)this.#E(e,(r.length-l-1).toString())&&(n=!1);r.length=t.length;for(let l=0;l<t.length;l++)this.#m(e,l.toString(),t[l])&&(n=!1);if(n)return!1;let o=new f;return o.eventType="set",o.item_name=e,o.value=t,o.old_value=void 0,this.#i(e,o),this.#d([e]),o}hasItem(e){return e=="store"||this.#t.has(e)||this.#e.has(e)||this.#r.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}#d(e){var t=E(e),s=new Set;this.#e.forEach(i=>{this.#$(i,t,s)});var r=this,n=Array.from(s).filter(i=>r.hasSubscribers(i));n.forEach(i=>{let o=r.#e.get(i);o&&o.stale&&r.#w(o.item_name)})}setItems(e){if(this.#o)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t=[];for(let s in e){if(s=="store"||this.isComputedItem(s))continue;if(!this.hasItem(s)){if(this.#l){this.logError(`Store is sealed. Can't create the item "${s}"`);continue}this.#f(s,void 0)}let r=e[s],n;this.isAtomItem(s)&&(n=this.#S(s,r)),this.isCollection(s)&&(n=this.#A(s,r)),n&&t.push(s)}this.#d(t),this.#a()}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#t.has(e)}isCollection(e){return this.#r.has(e)}#j(e){return e.map(t=>{var s=this.#t.get(t)||this.#r.get(t);if(s)return s.version;var r=this.#e.get(t);if(r){if(!r.stale)return r.version;var n=this.#I(r.item_name);return r.version}}).join(",")}#w(e){let t=this.#e.get(e);if(t===void 0)throw new Error(`#recalc error: ${e}`);let s=t.value;if(t.is_hard){let o=t.memo,l=this.#j(t.dependencies);if(o===l)return t.stale=!1,!1;t.memo=l}t.stale=!0;let r=t.getter();t.stale=!1;let n=!0;if(this.#n[e]?n=this.#n[e](s,r,e,null):n=I(s,r),n)return!1;t.value=r,t.version++;let i=new f;return i.eventType="set",i.item_name=e,i.value=r,i.old_value=s,this.#i(e,i),i}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#w(e);return t&&this.#a(),t}#O(e,t,s={}){let r=this;var n=()=>{try{return t(r)}catch(d){return this.logError(`Computed error ${e}: `,d),"#ERROR!"}},i=this.getUsedItems(n),o=i.value,l=i.items,h=i.items.filter(d=>this.isComputedItem(d));if(h.forEach(d=>{this.#e.get(d)?.influences.add(e)}),l.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);var a=s.hasOwnProperty("is_hard")?s.is_hard:!1,c="";a&&(c=this.#j(l)),this.#e.set(e,{item_name:e,dependencies:l,influences:new Set,getter:n,value:o,stale:!1,memo:c,is_hard:a,version:0})}#$(e,t,s){if(e.stale)return!0;for(var r=e.dependencies,n=e.dependencies.filter(h=>this.#e.has(h)),i=0;i<r.length;i++)t.has(r[i])&&(e.stale=!0,s.add(e.item_name));var o=this;function l(h){h.influences.forEach(a=>{let c=o.#e.get(a);c&&(c.stale||(c.stale=!0,s.add(a),c.influences.size>0&&l(c)))})}return n.forEach(h=>{let a=o.#e.get(h);a&&l(a)}),!1}#N(e,t,s=!1,r={}){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!s&&!this.#p(e))throw new Error(`${e} is wrong store's item_name`);return this.#O(e,t,r),!0}createComputedItem(e,t,s={}){return this.#l?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#N(e,t,!1,s)}createCollectionItem(e,t){e=e.trim();var s=t.length;if(this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#p(e))throw new Error(`${e} is wrong store's item_name`);var r=this,n=new Proxy(t,{deleteProperty:function(i,o){let l=i.length;return typeof o=="symbol"?delete i[o]:typeof o=="string"&&r.#E(e,o)&&(delete i[o],r.#d([e]),r.#a()),!0},set:function(i,o,l,h){if(typeof o=="symbol")i[o]=l;else if(typeof o=="string"){let a=r.#r.get(e)||{value:[],version:0},c=a.value,d=parseInt(o),S=c.length;if(!isNaN(d)&&d>=c.length){let v=new f;v.eventType="set",v.item_name=e,v.property="length",v.value=d+1,v.old_value=S,r.#i(e,v),a.version++}r.#m(e,o,l)&&(i[o]=l,r.#d([e]),r.#a())}return!0}});return r.#r.set(e,{version:0,value:t}),r.#v.set(e,n),n}onChange(e){return this.#s.on("#change",e)}onChangeAny(e,t){let s=[];for(let i=0;i<e.length;i++){let o=e[i];if(typeof o=="string"){this.hasItem(o)&&s.push(o);continue}(o instanceof b||o instanceof p||o instanceof g)&&o.store===this&&s.push(o.name)}if(s.length==0)return;let r=this;return this.#s.on("#change",function(i){let o=!1,l={};for(let h in i)if(s.indexOf(h)>-1){o=!0,l[h]=i[h];break}o&&t(l,r)})}deleteItem(e){if(this.#l)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new f;return s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#t.delete(e),this.isCollection(e)&&(this.#r.delete(e),this.#v.delete(e)),this.#i(e,s),this.#a(),!0}#x(){return Object.fromEntries(this.#t)}getItems(e=!1){return e?Object.assign({},this.#x(),this.#U()):this.#x()}#I(e){this.#h&&this.#u.add(e);let t=this.#e.get(e);if(t===void 0)throw new Error(`#getComputedValue error: ${e}`);t.stale&&this.#w(e);let s=this.#e.get(e);if(s===void 0)throw new Error(`#getComputedValue error: ${e}`);return s.value}#T(e){return this.#h&&this.#u.add(e),this.#v.get(e)}#U(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#I(t.item_name)}),e}#k(e){this.#h&&this.#u.add(e);var t=this.#t.get(e),s=t?t.value:void 0;return s}getItem(e){if(e=="store")return this;if(this.hasItem(e)){if(this.isAtomItem(e))return this.#k(e);if(this.isComputedItem(e))return this.#I(e);if(this.isCollection(e))return this.#T(e)}}getItemNames(){let e=[];return this.#t.forEach((t,s)=>{e.push(s)}),this.#e.forEach((t,s)=>{e.push(s)}),this.#r.forEach((t,s)=>{e.push(s)}),e}subscribe(e,t,s){s===void 0&&(s=this.#C);var r=s<=0?t:m(t,s);let n=this.#s.on(e,r);return this.#s.events[e].length==1&&this.#s.emit("#has-subscribers:"+e,e,this),()=>{n(),this.#s.events[e]&&this.#s.events[e].length==0&&this.#s.emit("#no-subscribers:"+e,e,this)}}hasSubscribers(e){let t=this.#s.events[e];return t?t.length>0:!1}clearSubscribers(){this.#s.events={}}clearItemSubscribers(e){let t=!1;this.#s.events[e]&&this.#s.events[e].length>0&&(t=!0),delete this.#s.events[e],t&&this.#s.emit("#no-subscribers:"+e)}reset(){this.#t.clear(),this.#e.clear(),this.#r.clear(),this.clearSubscribers()}asObject(){return this.#b||(this.#b=this.#P()),this.#b}#P(){let e={},t=this,s={get(r,n){return typeof n=="string"?t.getItem(n):null},set(r,n,i){return t.setItems({[n]:i}),!0},ownKeys(r){return t.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,n){return typeof n=="string"&&t.deleteItem(n),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#n[e]=t,!0):!1}isSealed(){return this.#l}seal(){this.#l=!0}unseal(){this.#l=!1}#i(e,t){this.#c.push([e,t])}#a(){if(!this.#o){this.#o=!0;for(var e={},t=0;t<this.#c.length;){let s=this.#c[t];this.#s.emit(s[0],s[1],this),t++,e[s[0]]||(e[s[0]]=[]),e[s[0]].push(s[1])}this.#s.emit("#change",e,this),this.#c=[],this.#o=!1,this.#s.emit("#reactions_finished",this)}}setDebounceTime(e){this.#C=e<0?0:e}next(e){this.#o?this.#s.once("#reactions_finished",e):e(this)}#y(){for(;this.hasItem("_"+this.#g);)this.#g++;return"_"+this.#g}createAtom(e,t){return typeof t>"u"&&(t=this.#y()),new b(this,t,e)}getAtom(e){if(this.isAtomItem(e))return new b(this,e,this.getItem(e));throw new Error(`Unknown atom ${e}`)}createComputed(e,t,s={}){return typeof t>"u"&&(t=this.#y()),new p(this,t,e,s)}getComputed(e){if(!this.isComputedItem(e))throw new Error(`Unknown computed ${e}`);return new p(this,e)}createCollection(e,t){return typeof t>"u"&&(t=this.#y()),new g(this,t,e)}getCollection(e){if(this.isCollection(e))return new g(this,e);throw new Error(`Unknown collection ${e}`)}observeObject(e){if(!y(e))throw new Error(`obj must have an object type. obj = ${e}`);let t=this,s={store:{get(){return t}}};for(let r in e){let n=e[r];if(n instanceof Function||typeof n=="symbol"||(s[r]={get(){return t.getItem(r)},set(i){t.setItem(r,i)}}),this.hasItem(r)){if(this.isCollection(r)){let i=Array.isArray(n)?n:[];this.#A(r,i);continue}if(this.isAtomItem(r)){this.#S(r,n);continue}}else{if(Array.isArray(n)){this.createCollectionItem(r,n);continue}if(n instanceof Function||typeof n=="symbol")continue;this.#f(r,n);continue}}return Object.defineProperties(e,s),e}getUsedItems(e){this.#u.clear(),this.#h=!0;let t=e();var s=Array.from(this.#u);return this.#h=!1,this.#u.clear(),{value:t,items:s}}autorun(e,t={}){return this.createComputed(e,void 0,t).subscribe(()=>{})}reaction(e,t,s={}){var r=this.getUsedItems(e);if(r.items.length>0)return this.createComputed(e,void 0,s).subscribe(t)}when(e,t){var s=this.getUsedItems(e);return t?this.onChangeAny(s.items,()=>{try{e()&&t()}catch(r){this.logError(r)}}):new Promise((r,n)=>{var i=this.onChangeAny(s.items,()=>{let o=e();o&&(i&&i(),r(o))})})}onHasSubscribers(e,t){return this.#s.on("#has-subscribers:"+e,t)}onNoSubscribers(e,t){return this.#s.on("#no-subscribers:"+e,t)}};function G(u){return new C(u)}export{b as Atom,g as Collection,p as Computed,w as EventEmitter,C as Store,f as UpdateEventDetails,G as createStore,m as debounce};
