var d=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,r,i=[].slice.call(arguments,1);for(s=this.events[e].slice(),r=s.length,t=0;t<r;t++)try{s[t].apply(this,i)}catch(n){console.error(e,i),console.error(n)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};var g=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&(this.value=s)}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}setCompareFunction(e){return this.#e.setCompareFunction(this.#t,e)}get store(){return this.#e}};var p=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createCollectionItem(this.#t,s)}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}get store(){return this.#e}};var b=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createComputedItem(this.#t,s)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}recalc(){return this.#e.recalcComputed(this.#t)}get store(){return this.#e}};function v(o,e){if(o===e)return!0;if(o===null||e===null||o===void 0||e===void 0||typeof o!=typeof e)return!1;if(Array.isArray(o)||Array.isArray(e))return JSON.stringify(o)===JSON.stringify(e);let t=JSON.stringify(o,Object.keys(o).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function I(o,e){var t,s=(...r)=>{var i=this,n=function(){t=null,o.apply(i,r)};clearTimeout(t),t=setTimeout(n,e)};return s}function y(o){return typeof o=="object"&&!Array.isArray(o)&&o!==null}var c=class{value;old_value;item_name;eventType;property=null},C=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,w=class{#t=new Map;#e=new Map;#s=new Map;#b=new Map;#v=null;#n={};#o=!1;#l=!1;#f=[];#m=0;#r=new d;#c=!1;#a=new Set;#w=0;log=console.log;logError=console.error;warn=console.warn;constructor(e){if(e)for(let t in e){let s=e[t];if(s==null){this.#d(t,s);continue}if(Array.isArray(s)){this.createCollection(s,t);continue}s instanceof Function||this.#d(t,s)}}#I(e){return C.test(e)}#C(e,t){let s=this.#t.get(e);this.#t.set(e,t);let r=!0;if(this.#n[e]?r=this.#n[e](s,t,e,null):r=v(s,t),!r){let i=new c;return i.eventType="set",i.item_name=e,i.value=t,i.old_value=s,i}return!1}#d(e,t){if(!this.#I(e))throw new Error(`${e} is wrong store's item_name`);this.#t.set(e,t)}#S(e,t,s){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let r=this.#s.get(e)||[],i=r[t],n=!0;if(this.#n[e]?n=this.#n[e](i,s,e,t):n=v(i,s),n)return!1;r[t]=s;let l=new c;return l.eventType="set",l.item_name=e,l.property=t,l.value=s,l.old_value=i,l}#E(e,t){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let s=this.#s.get(e);if(s===void 0)throw new Error(`#deleteCollectionItem error: ${e}`);let r=s[t];delete s[t];let i=new c;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=r,i}#A(e,t){Array.isArray(t)||(this.warn(`Cannot assign a non-array value to a collection. Now ${e} == [].`),t=[]);let s=this.#s.get(e)||[],r=new Array(s.length);for(let h=0;h<s.length;h++)r[h]=s[h];let i=!0,n=[],l=s.length;if(s.length>t.length)for(let h=t.length;h<s.length;h++){let u=this.#E(e,(s.length-h-1).toString());u&&(n.push(u),i=!1)}s.length=t.length;for(let h=0;h<t.length;h++){let u=this.#S(e,h.toString(),t[h]);u&&(n.push(u),i=!1)}if(i)return!1;let a=new c;if(a.eventType="set",a.item_name=e,a.value=t,l!=t.length){let h=new c;h.eventType="set",h.item_name=e,h.property="length",h.value=t.length,h.old_value=l,this.#i(e,h),this.#h({[e]:h},"set"),this.#g(e,!1)}return{main_details:a,details_arr:n}}hasItem(e){return e=="store"||this.#t.has(e)||this.#e.has(e)||this.#s.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}#g(e,t=!0){var s={},r=new Set;r.add(e),this.#e.forEach(i=>{if(!this.#x(i,r)||!this.hasSubscribers(i.item_name))return;let l=this.#p(i.item_name);l!==!1&&(this.#i(l.item_name,l),s[i.item_name]=l)}),Object.keys(s).length>0&&(this.#h(s,"set"),t&&this.#u())}setItems(e){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t={},s=[],r=!1,i=new Set;for(let n in e){if(n=="store"||this.isComputedItem(n))continue;if(!this.hasItem(n)){if(this.#o){this.logError(`Store is sealed. Can't create the item "${n}"`);continue}this.#d(n,void 0)}let l=e[n],a=this.isAtomItem(n),h=this.isCollection(n);if(a){let u=this.#C(n,l);if(u==!1)continue;r=!0,t[n]=u,s.push(u),i.add(n)}if(h){let u=this.#A(n,l);if(u==!1)continue;r=!0;let{main_details:f,details_arr:m}=u;t[n]=f,s.push(...m,f),i.add(n)}}if(r){this.#e.forEach(n=>{if(!this.#x(n,i)||!this.hasSubscribers(n.item_name))return;let a=this.#p(n.item_name);a!==!1&&(t[n.item_name]=a,s.push(a))});for(let n=0;n<s.length;n++){let l=s[n];this.#i(l.item_name,l)}this.#h(t,"set"),this.#u()}}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#t.has(e)}isCollection(e){return this.#s.has(e)}#p(e){let t=this.#e.get(e);if(t===void 0)throw new Error(`#recalc error: ${e}`);let s=t.value;t.stale=!0;let r=t.getter();t.stale=!1;let i=!0;if(this.#n[e]?i=this.#n[e](s,r,e,null):i=v(s,r),i)return!1;t.value=r;let n=new c;return n.eventType="set",n.item_name=e,n.value=r,n.old_value=s,n}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#p(e);return t&&this.hasSubscribers(e)&&(this.#i(e,t),this.#u()),t}#T(e,t){let s=this;var r=()=>{try{return t(s)}catch(l){return this.logError(`Computed error ${e}: `,l),"#ERROR!"}};this.#a.clear(),this.#c=!0;let i=r();var n=Array.from(this.#a);if(n.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);this.#c=!1,this.#a.clear(),this.#e.set(e,{item_name:e,dependencies:n,getter:r,value:i,stale:!1})}#x(e,t){for(var s=e.dependencies,r=0;r<s.length;r++)if(t.has(s[r]))return e.stale=!0,!0;return!1}#$(e,t,s=!1){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!s&&!this.#I(e))throw new Error(`${e} is wrong store's item_name`);return this.#T(e,t),!0}createComputedItem(e,t){return this.#o?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#$(e,t)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,r=e,i=r.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let h of i){let u=h[0].slice(1);this.hasItem(u)&&s.add(u)}var n=Array.from(s),l=n.map(h=>`var $${h} = store.getItem("${h}");`).join(`
`),a=new Function("store",`
    ${l}
    return ${e};
`);return this.#$(t,a,n,!0),t}createCollectionItem(e,t){e=e.trim();var s=t.length;if(this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#I(e))throw new Error(`${e} is wrong store's item_name`);var r=this,i=new Proxy(t,{deleteProperty:function(n,l){let a=n.length;if(typeof l=="symbol")delete n[l];else if(typeof l=="string"){let h=r.#E(e,l);h&&(delete n[l],r.#i(h.item_name,h),r.#h({[e]:h},"delete"),r.#g(e),r.#u())}return!0},set:function(n,l,a,h){if(typeof l=="symbol")n[l]=a;else if(typeof l=="string"){let u=r.#S(e,l,a);if(u){if(n[l]=a,s!=n.length){let f=new c;f.eventType="set",f.item_name=e,f.property="length",f.value=n.length,f.old_value=s,s=n.length,r.#i(e,f),r.#h({[e]:f},"set"),r.#g(e),r.#u()}r.#i(u.item_name,u),r.#h({[e]:u},"set"),r.#g(e),r.#u()}}return!0}});return r.#s.set(e,t),r.#b.set(e,i),i}onChange(e){return this.#r.on("#change",e)}onChangeAny(e,t){if(e.length==0)return;let s=this;return this.#r.on("#change",function(i){let n=i.details,l=!1;for(let a in n)if(e.indexOf(a)>-1){l=!0;break}l&&t(i,s)})}deleteItem(e){if(this.#o)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new c;return s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#t.delete(e),this.isCollection(e)&&(this.#s.delete(e),this.#b.delete(e)),this.#h({[e]:s},"delete"),!0}#j(){return Object.fromEntries(this.#t)}getItems(e=!1){return e?Object.assign({},this.#j(),this.#N()):this.#j()}#O(e){let t=this.#e.get(e);if(t===void 0)throw new Error(`#getComputedValue error: ${e}`);t.stale&&this.#p(e);let s=this.#e.get(e);if(s===void 0)throw new Error(`#getComputedValue error: ${e}`);return s.value}#k(e){return this.#c&&this.#a.add(e),this.#b.get(e)}#N(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#O(t.item_name)}),e}#F(e){return this.#c&&this.#a.add(e),this.#t.get(e)}getItem(e){if(e=="store")return this;if(this.hasItem(e)){if(this.isAtomItem(e))return this.#F(e);if(this.isComputedItem(e))return this.#O(e);if(this.isCollection(e))return this.#k(e)}}getItemNames(){let e=[];return this.#t.forEach((t,s)=>{e.push(s)}),this.#e.forEach((t,s)=>{e.push(s)}),this.#s.forEach((t,s)=>{e.push(s)}),e}subscribe(e,t,s){s===void 0&&(s=this.#m);var r=s<=0?t:I(t,s);return this.#r.on(e,r)}hasSubscribers(e){let t=this.#r.events[e];return t?t.length>0:!1}clearSubscribers(){this.#r.events={}}clearItemSubscribers(e){delete this.#r.events[e]}reset(){this.#t.clear(),this.#e.clear(),this.#s.clear(),this.clearSubscribers()}#h(e,t=null){let s={details:e,eventType:t};this.#i("#change",s)}asObject(){return this.#v||(this.#v=this.#P()),this.#v}#P(){let e={},t=this,s={get(r,i){return typeof i=="string"?t.getItem(i):null},set(r,i,n){return t.setItems({[i]:n}),!0},ownKeys(r){return t.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,i){return typeof i=="string"&&t.deleteItem(i),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#n[e]=t,!0):!1}isSealed(){return this.#o}seal(){this.#o=!0}unseal(){this.#o=!1}#i(e,t){this.#f.push([e,t])}#u(){if(!this.#l){this.#l=!0;for(var e=0;e<this.#f.length;){let t=this.#f[e];this.#r.emit(t[0],t[1],this),e++}this.#f=[],this.#l=!1,this.#r.emit("#reactions_finished",this)}}setDebounceTime(e){this.#m=e<0?0:e}next(e){this.#l?this.#r.once("#reactions_finished",e):e(this)}#y(){for(;this.hasItem("_"+this.#w);)this.#w++;return"_"+this.#w}createAtom(e,t){return typeof t>"u"&&(t=this.#y()),new g(this,t,e)}getAtom(e){return this.isAtomItem(e)?new g(this,e):!1}createComputed(e,t){return typeof t>"u"&&(t=this.#y()),new b(this,t,e)}getComputed(e){return this.isComputedItem(e)?new b(this,e):!1}createCollection(e,t){return typeof t>"u"&&(t=this.#y()),new p(this,t,e)}getCollection(e){return this.isCollection(e)?new p(this,e):!1}observeObject(e){if(!y(e))throw new Error(`obj must have an object type. obj = ${e}`);let t=this,s={store:{get(){return t}}};for(let r in e){let i=e[r];if(i instanceof Function||typeof i=="symbol"||(s[r]={get(){return t.getItem(r)},set(n){t.setItem(r,n)}}),this.hasItem(r)){if(this.isCollection(r)){let n=Array.isArray(i)?i:[];this.#A(r,n);continue}if(this.isAtomItem(r)){this.#C(r,i);continue}}else{if(Array.isArray(i)){this.createCollectionItem(r,i);continue}if(i instanceof Function||typeof i=="symbol")continue;this.#d(r,i);continue}}return Object.defineProperties(e,s),e}};function R(o){return new w(o)}export{d as EventEmitter,w as Store,c as UpdateEventDetails,R as createStore,I as debounce};
