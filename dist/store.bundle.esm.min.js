var w=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,r,i=[].slice.call(arguments,1);for(s=this.events[e].slice(),r=s.length,t=0;t<r;t++)try{s[t].apply(this,i)}catch(l){console.error(e,i),console.error(l)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};var p=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,this.value=s}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}setCompareFunction(e){return this.#e.setCompareFunction(this.#t,e)}get store(){return this.#e}};var v=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createCollectionItem(this.#t,s)}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}get store(){return this.#e}};var b=class{#t;#e;constructor(e,t,s,r={}){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createComputedItem(this.#t,s,r)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}recalc(){return this.#e.recalcComputed(this.#t)}get store(){return this.#e}};function I(o,e){if(o===e)return!0;if(o===null||e===null||o===void 0||e===void 0||typeof o!=typeof e)return!1;if(Array.isArray(o)||Array.isArray(e))return JSON.stringify(o)===JSON.stringify(e);let t=JSON.stringify(o,Object.keys(o).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function y(o,e){var t,s=(...r)=>{var i=this,l=function(){t=null,o.apply(i,r)};clearTimeout(t),t=setTimeout(l,e)};return s}function C(o){return typeof o=="object"&&!Array.isArray(o)&&o!==null}function S(o){var e=new Set;for(let t=0;t<o.length;t++)e.add(o[t]);return e}var c=class{value;old_value;item_name;eventType;property=null},A=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,m=class{#t=new Map;#e=new Map;#s=new Map;#g=new Map;#p=null;#n={};#o=!1;#l=!1;#f=[];#m=0;#r=new w;#u=!1;#h=new Set;#v=0;log=console.log;logError=console.error;warn=console.warn;constructor(e){if(e)for(let t in e){let s=e[t];if(s==null){this.#c(t,s);continue}if(Array.isArray(s)){this.createCollection(s,t);continue}s instanceof Function||this.#c(t,s)}}#b(e){return A.test(e)}#y(e,t){let s=this.#t.get(e);this.#t.set(e,t);let r=!0;if(this.#n[e]?r=this.#n[e](s,t,e,null):r=I(s,t),!r){let i=new c;return i.eventType="set",i.item_name=e,i.value=t,i.old_value=s,this.#i(e,i),i}return!1}#c(e,t){if(!this.#b(e))throw new Error(`${e} is wrong store's item_name`);this.#t.set(e,t)}#C(e,t,s){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let r=this.#s.get(e)||[],i=r[t],l=!0;if(this.#n[e]?l=this.#n[e](i,s,e,t):l=I(i,s),l)return!1;r[t]=s;let n=new c;return n.eventType="set",n.item_name=e,n.property=t,n.value=s,n.old_value=i,this.#i(e,n),n}#S(e,t){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let s=this.#s.get(e);if(s===void 0)throw new Error(`#deleteCollectionItem error: ${e}`);let r=s[t];delete s[t];let i=new c;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=r,this.#i(e,i),i}#E(e,t){Array.isArray(t)||(this.warn(`Cannot assign a non-array value to a collection. Now ${e} == [].`),t=[]);let s=this.#s.get(e)||[],r=!0,i=s.length;if(i!=t.length){let n=new c;n.eventType="set",n.item_name=e,n.property="length",n.value=t.length,n.old_value=i,this.#i(e,n)}if(s.length>t.length)for(let n=t.length;n<s.length;n++)this.#S(e,(s.length-n-1).toString())&&(r=!1);s.length=t.length;for(let n=0;n<t.length;n++)this.#C(e,n.toString(),t[n])&&(r=!1);if(r)return!1;let l=new c;return l.eventType="set",l.item_name=e,l.value=t,l.old_value=void 0,this.#i(e,l),this.#d([e]),l}hasItem(e){return e=="store"||this.#t.has(e)||this.#e.has(e)||this.#s.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}#d(e){var t=S(e),s=new Set;this.#e.forEach(l=>{this.#O(l,t,s)});var r=this,i=Array.from(s).filter(l=>r.hasSubscribers(l));i.forEach(l=>{let n=r.#e.get(l);n&&n.stale&&r.#w(n.item_name)})}setItems(e){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t=[];for(let s in e){if(s=="store"||this.isComputedItem(s))continue;if(!this.hasItem(s)){if(this.#o){this.logError(`Store is sealed. Can't create the item "${s}"`);continue}this.#c(s,void 0)}let r=e[s],i;this.isAtomItem(s)&&(i=this.#y(s,r)),this.isCollection(s)&&(i=this.#E(s,r)),i&&t.push(s)}this.#d(t),this.#a()}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#t.has(e)}isCollection(e){return this.#s.has(e)}#w(e){let t=this.#e.get(e);if(t===void 0)throw new Error(`#recalc error: ${e}`);let s=t.value;if(t.is_hard){let n=t.memo,h=JSON.stringify(t.dependencies.map(u=>this.getItem(u)));if(n===h)return t.stale=!1,!1;t.memo=h}t.stale=!0;let r=t.getter();t.stale=!1;let i=!0;if(this.#n[e]?i=this.#n[e](s,r,e,null):i=I(s,r),i)return!1;t.value=r;let l=new c;return l.eventType="set",l.item_name=e,l.value=r,l.old_value=s,this.#i(e,l),l}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#w(e);return t&&this.#a(),t}#j(e,t,s={}){let r=this;var i=()=>{try{return t(r)}catch(d){return this.logError(`Computed error ${e}: `,d),"#ERROR!"}},l=this.getUsedItems(i),n=l.value,h=l.items,u=l.items.filter(d=>this.isComputedItem(d));if(u.forEach(d=>{this.#e.get(d)?.influences.add(e)}),h.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);let a=s.hasOwnProperty("is_hard")?s.is_hard:!1,f="";a&&(f=JSON.stringify(h.map(d=>this.getItem(d)))),this.#e.set(e,{item_name:e,dependencies:h,influences:new Set,getter:i,value:n,stale:!1,memo:f,is_hard:a})}#O(e,t,s){if(e.stale)return!0;for(var r=e.dependencies,i=e.dependencies.filter(u=>this.#e.has(u)),l=0;l<r.length;l++)t.has(r[l])&&(e.stale=!0,s.add(e.item_name));var n=this;function h(u){u.influences.forEach(a=>{let f=n.#e.get(a);f&&(f.stale||(f.stale=!0,s.add(a),f.influences.size>0&&h(f)))})}return i.forEach(u=>{let a=n.#e.get(u);a&&h(a)}),!1}#A(e,t,s=!1,r={}){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!s&&!this.#b(e))throw new Error(`${e} is wrong store's item_name`);return this.#j(e,t,r),!0}createComputedItem(e,t,s={}){return this.#o?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#A(e,t,!1,s)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,r=e,i=r.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let u of i){let a=u[0].slice(1);this.hasItem(a)&&s.add(a)}var l=Array.from(s),n=l.map(u=>`var $${u} = store.getItem("${u}");`).join(`
`),h=new Function("store",`
    ${n}
    return ${e};
`);return this.#A(t,h,l,!0),t}createCollectionItem(e,t){e=e.trim();var s=t.length;if(this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#b(e))throw new Error(`${e} is wrong store's item_name`);var r=this,i=new Proxy(t,{deleteProperty:function(l,n){let h=l.length;return typeof n=="symbol"?delete l[n]:typeof n=="string"&&r.#S(e,n)&&(delete l[n],r.#d([e]),r.#a()),!0},set:function(l,n,h,u){if(typeof n=="symbol")l[n]=h;else if(typeof n=="string"){let a=r.#s.get(e)||[],f=parseInt(n),d=a.length;if(!isNaN(f)&&f>=a.length){let g=new c;g.eventType="set",g.item_name=e,g.property="length",g.value=f+1,g.old_value=d,r.#i(e,g)}r.#C(e,n,h)&&(l[n]=h,r.#d([e]),r.#a())}return!0}});return r.#s.set(e,t),r.#g.set(e,i),i}onChange(e){return this.#r.on("#change",e)}onChangeAny(e,t){let s=[];for(let l=0;l<e.length;l++){let n=e[l];if(typeof n=="string"){this.hasItem(n)&&s.push(n);continue}(n instanceof p||n instanceof b||n instanceof v)&&n.store===this&&s.push(n.name)}if(s.length==0)return;let r=this;return this.#r.on("#change",function(l){let n=!1,h={};for(let u in l)if(s.indexOf(u)>-1){n=!0,h[u]=l[u];break}n&&t(h,r)})}deleteItem(e){if(this.#o)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new c;return s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#t.delete(e),this.isCollection(e)&&(this.#s.delete(e),this.#g.delete(e)),this.#i(e,s),this.#a(),!0}#x(){return Object.fromEntries(this.#t)}getItems(e=!1){return e?Object.assign({},this.#x(),this.#N()):this.#x()}#$(e){this.#u&&this.#h.add(e);let t=this.#e.get(e);if(t===void 0)throw new Error(`#getComputedValue error: ${e}`);t.stale&&this.#w(e);let s=this.#e.get(e);if(s===void 0)throw new Error(`#getComputedValue error: ${e}`);return s.value}#T(e){return this.#u&&this.#h.add(e),this.#g.get(e)}#N(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#$(t.item_name)}),e}#U(e){return this.#u&&this.#h.add(e),this.#t.get(e)}getItem(e){if(e=="store")return this;if(this.hasItem(e)){if(this.isAtomItem(e))return this.#U(e);if(this.isComputedItem(e))return this.#$(e);if(this.isCollection(e))return this.#T(e)}}getItemNames(){let e=[];return this.#t.forEach((t,s)=>{e.push(s)}),this.#e.forEach((t,s)=>{e.push(s)}),this.#s.forEach((t,s)=>{e.push(s)}),e}subscribe(e,t,s){s===void 0&&(s=this.#m);var r=s<=0?t:y(t,s);return this.#r.on(e,r)}hasSubscribers(e){let t=this.#r.events[e];return t?t.length>0:!1}clearSubscribers(){this.#r.events={}}clearItemSubscribers(e){delete this.#r.events[e]}reset(){this.#t.clear(),this.#e.clear(),this.#s.clear(),this.clearSubscribers()}asObject(){return this.#p||(this.#p=this.#k()),this.#p}#k(){let e={},t=this,s={get(r,i){return typeof i=="string"?t.getItem(i):null},set(r,i,l){return t.setItems({[i]:l}),!0},ownKeys(r){return t.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,i){return typeof i=="string"&&t.deleteItem(i),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#n[e]=t,!0):!1}isSealed(){return this.#o}seal(){this.#o=!0}unseal(){this.#o=!1}#i(e,t){this.#f.push([e,t])}#a(){if(!this.#l){this.#l=!0;for(var e={},t=0;t<this.#f.length;){let s=this.#f[t];this.#r.emit(s[0],s[1],this),t++,e[s[0]]||(e[s[0]]=[]),e[s[0]].push(s[1])}this.#r.emit("#change",e,this),this.#f=[],this.#l=!1,this.#r.emit("#reactions_finished",this)}}setDebounceTime(e){this.#m=e<0?0:e}next(e){this.#l?this.#r.once("#reactions_finished",e):e(this)}#I(){for(;this.hasItem("_"+this.#v);)this.#v++;return"_"+this.#v}createAtom(e,t){return typeof t>"u"&&(t=this.#I()),new p(this,t,e)}getAtom(e){if(this.isAtomItem(e))return new p(this,e);throw new Error(`Unknown atom ${e}`)}createComputed(e,t,s={}){return typeof t>"u"&&(t=this.#I()),new b(this,t,e,s)}getComputed(e){if(this.isComputedItem(e))return new b(this,e);throw new Error(`Unknown computed ${e}`)}createCollection(e,t){return typeof t>"u"&&(t=this.#I()),new v(this,t,e)}getCollection(e){if(this.isCollection(e))return new v(this,e);throw new Error(`Unknown collection ${e}`)}observeObject(e){if(!C(e))throw new Error(`obj must have an object type. obj = ${e}`);let t=this,s={store:{get(){return t}}};for(let r in e){let i=e[r];if(i instanceof Function||typeof i=="symbol"||(s[r]={get(){return t.getItem(r)},set(l){t.setItem(r,l)}}),this.hasItem(r)){if(this.isCollection(r)){let l=Array.isArray(i)?i:[];this.#E(r,l);continue}if(this.isAtomItem(r)){this.#y(r,i);continue}}else{if(Array.isArray(i)){this.createCollectionItem(r,i);continue}if(i instanceof Function||typeof i=="symbol")continue;this.#c(r,i);continue}}return Object.defineProperties(e,s),e}getUsedItems(e){this.#h.clear(),this.#u=!0;let t=e();var s=Array.from(this.#h);return this.#u=!1,this.#h.clear(),{value:t,items:s}}autorun(e){var t=this.getUsedItems(e);if(t.items.length>0)return this.onChangeAny(t.items,e)}reaction(e,t){var s=this.getUsedItems(e);if(s.items.length>0)return this.onChangeAny(s.items,t)}when(e,t){var s=this.getUsedItems(e);return t?this.onChangeAny(s.items,()=>{try{e()&&t()}catch(r){this.logError(r)}}):new Promise((r,i)=>{var l=this.onChangeAny(s.items,()=>{let n=e();n&&(l&&l(),r(n))})})}};function B(o){return new m(o)}export{w as EventEmitter,m as Store,c as UpdateEventDetails,B as createStore,y as debounce};
