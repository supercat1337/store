var w=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let r=this;return function(){r.removeListener(e,t)}}removeListener(e,t){var r;typeof this.events[e]=="object"&&(r=this.events[e].indexOf(t),r>-1&&this.events[e].splice(r,1))}emit(e){if(typeof this.events[e]=="object"){var t,r,s,n=[].slice.call(arguments,1);for(r=this.events[e].slice(),s=r.length,t=0;t<s;t++)try{r[t].apply(this,n)}catch(i){console.error(e,n),console.error(i)}}}once(e,t){return this.on(e,function r(){this.removeListener(e,r),t.apply(this,arguments)})}};var g=class{#t;#e;constructor(e,t,r){this.#e=e,this.#t=t,this.value=r}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}setCompareFunction(e){return this.#e.setCompareFunction(this.#t,e)}get store(){return this.#e}};var p=class{#t;#e;constructor(e,t,r){this.#e=e,this.#t=t,typeof r<"u"&&this.#e.createCollectionItem(this.#t,r)}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}get store(){return this.#e}};var b=class{#t;#e;constructor(e,t,r,s={}){this.#e=e,this.#t=t,typeof r<"u"&&this.#e.createComputedItem(this.#t,r,s)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}recalc(){return this.#e.recalcComputed(this.#t)}get store(){return this.#e}};function m(u,e){if(u===e)return!0;if(u===null||e===null||u===void 0||e===void 0||typeof u!=typeof e)return!1;if(Array.isArray(u)||Array.isArray(e))return JSON.stringify(u)===JSON.stringify(e);let t=JSON.stringify(u,Object.keys(u).sort()),r=JSON.stringify(e,Object.keys(e).sort());return t===r}function C(u,e){var t,r=(...s)=>{var n=this,i=function(){t=null,u.apply(n,s)};clearTimeout(t),t=setTimeout(i,e)};return r}function E(u){return typeof u=="object"&&!Array.isArray(u)&&u!==null}function S(u){var e=new Set;for(let t=0;t<u.length;t++)e.add(u[t]);return e}var f=class{value;old_value;item_name;eventType;property=null},A=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,I=class{#t=new Map;#e=new Map;#r=new Map;#v=new Map;#g=null;#n={};#l=!1;#o=!1;#c=[];#y=0;#s=new w;#h=!1;#u=new Set;#p=0;log=console.log;logError=console.error;warn=console.warn;constructor(e){if(e)for(let t in e){let r=e[t];if(r==null){this.#f(t,r);continue}if(Array.isArray(r)){this.createCollection(r,t);continue}r instanceof Function||this.#f(t,r)}}#b(e){return A.test(e)}#C(e,t){var r=0,s=void 0,n=this.#t.get(e)||{version:0,value:void 0};n&&(r=n.version,s=n.value);let i=!0;if(this.#n[e]?i=this.#n[e](s,t,e,null):i=m(s,t),!i){n.value=t,n.version++,this.#t.set(e,n);let o=new f;return o.eventType="set",o.item_name=e,o.value=t,o.old_value=s,this.#i(e,o),o}return!1}#f(e,t){if(!this.#b(e))throw new Error(`${e} is wrong store's item_name`);var r={version:0,value:t};this.#t.set(e,r)}#E(e,t,r){if(this.#o)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();var s=this.#r.get(e)||{value:[],version:0};let n=s.value,i=n[t],o=!0;if(this.#n[e]?o=this.#n[e](i,r,e,t):o=m(i,r),o)return!1;n[t]=r;let l=new f;return l.eventType="set",l.item_name=e,l.property=t,l.value=r,l.old_value=i,s.version++,this.#i(e,l),l}#S(e,t){if(this.#o)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();var r=this.#r.get(e)||{value:[],version:0},s=r.value;if(s===void 0)throw new Error(`#deleteCollectionItem error: ${e}`);var n=s[t];delete s[t];var i=new f;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=n,r.version++,this.#i(e,i),i}#A(e,t){Array.isArray(t)||(this.warn(`Cannot assign a non-array value to a collection. Now ${e} == [].`),t=[]);var r=this.#r.get(e)||{value:[],version:0},s=r.value,n=!0,i=s.length;if(i!=t.length){let l=new f;l.eventType="set",l.item_name=e,l.property="length",l.value=t.length,l.old_value=i,r.version++,this.#i(e,l)}if(s.length>t.length)for(let l=t.length;l<s.length;l++)this.#S(e,(s.length-l-1).toString())&&(n=!1);s.length=t.length;for(let l=0;l<t.length;l++)this.#E(e,l.toString(),t[l])&&(n=!1);if(n)return!1;let o=new f;return o.eventType="set",o.item_name=e,o.value=t,o.old_value=void 0,this.#i(e,o),this.#d([e]),o}hasItem(e){return e=="store"||this.#t.has(e)||this.#e.has(e)||this.#r.has(e)}setItem(e,t){var r={[e]:t};this.setItems(r)}#d(e){var t=S(e),r=new Set;this.#e.forEach(i=>{this.#T(i,t,r)});var s=this,n=Array.from(r).filter(i=>s.hasSubscribers(i));n.forEach(i=>{let o=s.#e.get(i);o&&o.stale&&s.#w(o.item_name)})}setItems(e){if(this.#o)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t=[];for(let r in e){if(r=="store"||this.isComputedItem(r))continue;if(!this.hasItem(r)){if(this.#l){this.logError(`Store is sealed. Can't create the item "${r}"`);continue}this.#f(r,void 0)}let s=e[r],n;this.isAtomItem(r)&&(n=this.#C(r,s)),this.isCollection(r)&&(n=this.#A(r,s)),n&&t.push(r)}this.#d(t),this.#a()}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#t.has(e)}isCollection(e){return this.#r.has(e)}#x(e){return e.map(t=>{var r=this.#t.get(t)||this.#r.get(t);if(r)return r.version;var s=this.#e.get(t);if(s){if(!s.stale)return s.version;var n=this.#m(s.item_name);return s.version}}).join(",")}#w(e){let t=this.#e.get(e);if(t===void 0)throw new Error(`#recalc error: ${e}`);let r=t.value;if(t.is_hard){let o=t.memo,l=this.#x(t.dependencies);if(o===l)return t.stale=!1,!1;t.memo=l}t.stale=!0;let s=t.getter();t.stale=!1;let n=!0;if(this.#n[e]?n=this.#n[e](r,s,e,null):n=m(r,s),n)return!1;t.value=s,t.version++;let i=new f;return i.eventType="set",i.item_name=e,i.value=s,i.old_value=r,this.#i(e,i),i}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#w(e);return t&&this.#a(),t}#O(e,t,r={}){let s=this;var n=()=>{try{return t(s)}catch(d){return this.logError(`Computed error ${e}: `,d),"#ERROR!"}},i=this.getUsedItems(n),o=i.value,l=i.items,h=i.items.filter(d=>this.isComputedItem(d));if(h.forEach(d=>{this.#e.get(d)?.influences.add(e)}),l.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);var a=r.hasOwnProperty("is_hard")?r.is_hard:!1,c="";a&&(c=this.#x(l)),this.#e.set(e,{item_name:e,dependencies:l,influences:new Set,getter:n,value:o,stale:!1,memo:c,is_hard:a,version:0})}#T(e,t,r){if(e.stale)return!0;for(var s=e.dependencies,n=e.dependencies.filter(h=>this.#e.has(h)),i=0;i<s.length;i++)t.has(s[i])&&(e.stale=!0,r.add(e.item_name));var o=this;function l(h){h.influences.forEach(a=>{let c=o.#e.get(a);c&&(c.stale||(c.stale=!0,r.add(a),c.influences.size>0&&l(c)))})}return n.forEach(h=>{let a=o.#e.get(h);a&&l(a)}),!1}#$(e,t,r=!1,s={}){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!r&&!this.#b(e))throw new Error(`${e} is wrong store's item_name`);return this.#O(e,t,s),!0}createComputedItem(e,t,r={}){return this.#l?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#$(e,t,!1,r)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var r=new Set,s=e,n=s.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let h of n){let a=h[0].slice(1);this.hasItem(a)&&r.add(a)}var i=Array.from(r),o=i.map(h=>`var $${h} = store.getItem("${h}");`).join(`
`),l=new Function("store",`
    ${o}
    return ${e};
`);return this.#$(t,l,i,!0),t}createCollectionItem(e,t){e=e.trim();var r=t.length;if(this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#b(e))throw new Error(`${e} is wrong store's item_name`);var s=this,n=new Proxy(t,{deleteProperty:function(i,o){let l=i.length;return typeof o=="symbol"?delete i[o]:typeof o=="string"&&s.#S(e,o)&&(delete i[o],s.#d([e]),s.#a()),!0},set:function(i,o,l,h){if(typeof o=="symbol")i[o]=l;else if(typeof o=="string"){let a=s.#r.get(e)||{value:[],version:0},c=a.value,d=parseInt(o),y=c.length;if(!isNaN(d)&&d>=c.length){let v=new f;v.eventType="set",v.item_name=e,v.property="length",v.value=d+1,v.old_value=y,s.#i(e,v),a.version++}s.#E(e,o,l)&&(i[o]=l,s.#d([e]),s.#a())}return!0}});return s.#r.set(e,{version:0,value:t}),s.#v.set(e,n),n}onChange(e){return this.#s.on("#change",e)}onChangeAny(e,t){let r=[];for(let i=0;i<e.length;i++){let o=e[i];if(typeof o=="string"){this.hasItem(o)&&r.push(o);continue}(o instanceof g||o instanceof b||o instanceof p)&&o.store===this&&r.push(o.name)}if(r.length==0)return;let s=this;return this.#s.on("#change",function(i){let o=!1,l={};for(let h in i)if(r.indexOf(h)>-1){o=!0,l[h]=i[h];break}o&&t(l,s)})}deleteItem(e){if(this.#l)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),r=new f;return r.eventType="delete",r.item_name=e,r.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#t.delete(e),this.isCollection(e)&&(this.#r.delete(e),this.#v.delete(e)),this.#i(e,r),this.#a(),!0}#j(){return Object.fromEntries(this.#t)}getItems(e=!1){return e?Object.assign({},this.#j(),this.#N()):this.#j()}#m(e){this.#h&&this.#u.add(e);let t=this.#e.get(e);if(t===void 0)throw new Error(`#getComputedValue error: ${e}`);t.stale&&this.#w(e);let r=this.#e.get(e);if(r===void 0)throw new Error(`#getComputedValue error: ${e}`);return r.value}#k(e){return this.#h&&this.#u.add(e),this.#v.get(e)}#N(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#m(t.item_name)}),e}#U(e){this.#h&&this.#u.add(e);var t=this.#t.get(e),r=t?t.value:void 0;return r}getItem(e){if(e=="store")return this;if(this.hasItem(e)){if(this.isAtomItem(e))return this.#U(e);if(this.isComputedItem(e))return this.#m(e);if(this.isCollection(e))return this.#k(e)}}getItemNames(){let e=[];return this.#t.forEach((t,r)=>{e.push(r)}),this.#e.forEach((t,r)=>{e.push(r)}),this.#r.forEach((t,r)=>{e.push(r)}),e}subscribe(e,t,r){r===void 0&&(r=this.#y);var s=r<=0?t:C(t,r);return this.#s.on(e,s)}hasSubscribers(e){let t=this.#s.events[e];return t?t.length>0:!1}clearSubscribers(){this.#s.events={}}clearItemSubscribers(e){delete this.#s.events[e]}reset(){this.#t.clear(),this.#e.clear(),this.#r.clear(),this.clearSubscribers()}asObject(){return this.#g||(this.#g=this.#F()),this.#g}#F(){let e={},t=this,r={get(s,n){return typeof n=="string"?t.getItem(n):null},set(s,n,i){return t.setItems({[n]:i}),!0},ownKeys(s){return t.getItemNames()},getOwnPropertyDescriptor(s){return{enumerable:!0,configurable:!0}},deleteProperty:function(s,n){return typeof n=="string"&&t.deleteItem(n),!0}};return new Proxy(e,r)}setCompareFunction(e,t){return this.hasItem(e)?(this.#n[e]=t,!0):!1}isSealed(){return this.#l}seal(){this.#l=!0}unseal(){this.#l=!1}#i(e,t){this.#c.push([e,t])}#a(){if(!this.#o){this.#o=!0;for(var e={},t=0;t<this.#c.length;){let r=this.#c[t];this.#s.emit(r[0],r[1],this),t++,e[r[0]]||(e[r[0]]=[]),e[r[0]].push(r[1])}this.#s.emit("#change",e,this),this.#c=[],this.#o=!1,this.#s.emit("#reactions_finished",this)}}setDebounceTime(e){this.#y=e<0?0:e}next(e){this.#o?this.#s.once("#reactions_finished",e):e(this)}#I(){for(;this.hasItem("_"+this.#p);)this.#p++;return"_"+this.#p}createAtom(e,t){return typeof t>"u"&&(t=this.#I()),new g(this,t,e)}getAtom(e){if(this.isAtomItem(e))return new g(this,e);throw new Error(`Unknown atom ${e}`)}createComputed(e,t,r={}){return typeof t>"u"&&(t=this.#I()),new b(this,t,e,r)}getComputed(e){if(this.isComputedItem(e))return new b(this,e);throw new Error(`Unknown computed ${e}`)}createCollection(e,t){return typeof t>"u"&&(t=this.#I()),new p(this,t,e)}getCollection(e){if(this.isCollection(e))return new p(this,e);throw new Error(`Unknown collection ${e}`)}observeObject(e){if(!E(e))throw new Error(`obj must have an object type. obj = ${e}`);let t=this,r={store:{get(){return t}}};for(let s in e){let n=e[s];if(n instanceof Function||typeof n=="symbol"||(r[s]={get(){return t.getItem(s)},set(i){t.setItem(s,i)}}),this.hasItem(s)){if(this.isCollection(s)){let i=Array.isArray(n)?n:[];this.#A(s,i);continue}if(this.isAtomItem(s)){this.#C(s,n);continue}}else{if(Array.isArray(n)){this.createCollectionItem(s,n);continue}if(n instanceof Function||typeof n=="symbol")continue;this.#f(s,n);continue}}return Object.defineProperties(e,r),e}getUsedItems(e){this.#u.clear(),this.#h=!0;let t=e();var r=Array.from(this.#u);return this.#h=!1,this.#u.clear(),{value:t,items:r}}autorun(e,t={}){return this.createComputed(e,void 0,t).subscribe(()=>{})}reaction(e,t,r={}){var s=this.getUsedItems(e);if(s.items.length>0)return this.createComputed(e,void 0,r).subscribe(t)}when(e,t){var r=this.getUsedItems(e);return t?this.onChangeAny(r.items,()=>{try{e()&&t()}catch(s){this.logError(s)}}):new Promise((s,n)=>{var i=this.onChangeAny(r.items,()=>{let o=e();o&&(i&&i(),s(o))})})}};function G(u){return new I(u)}export{w as EventEmitter,I as Store,f as UpdateEventDetails,G as createStore,C as debounce};
