var m=class{#e=new Map;#t=!1;autoRegister=!1;#r=new Map;#d=-1;#o=new Map;#i=new Map;#n=!1;#l=1;setListenerRunnerStrategy(e){this.#l=e}getListenerRunnerStrategy(){return this.#l}#c(e){let t=++this.#d;return this.#o.set(t,e),this.#i.set(t,0),t}#v(e){this.#o.delete(e)}#s(e){for(let[t,s]of this.#o)if(s===e)return t;return-1}#u(e,t){(this.#e.get(e)||new Set).add(t);let r=this.#i.get(t)||0;r++,this.#i.set(t,r)}#h(e,t){(this.#e.get(e)||new Set).delete(t);let r=this.#i.get(t)||1;r--,this.#i.set(t,r),this.#g(t)}#g(e){if((this.#i.get(e)||0)==0){this.#v(e),this.#i.delete(e);return}}mute(){this.#t=!0}unmute(){this.#t=!1,this.#f()}isMuted(){return this.#t}#f(){if(this.#r.size===0)return;this.#n=!0;let e=new Map;this.#e.forEach((s,r)=>{if(this.#r.has(r)){let i=this.#r.get(r)||[];s.forEach(n=>{e.set(n,i)})}}),this.#r.clear();let t=Array.from(e.keys());this.#l==0&&t.sort((s,r)=>s-r),t.forEach(s=>{let r=e.get(s)||[],i=this.#o.get(s);try{i&&i(...r)}catch(n){console.error(n)}}),this.#n=!1}registerEvents(...e){e.forEach(t=>{this.#e.has(t)||this.#e.set(t,new Set)})}unregisterEvents(...e){e.forEach(t=>{if(!this.#e.has(t))return;let s=this.#e.get(t);s&&(s.forEach(r=>{this.#h(t,r)}),this.#e.delete(t))})}unregisterAllEvents(){this.#e.clear(),this.#o.clear(),this.#i.clear(),this.#r.clear()}on(e,t){let s=()=>{};if(this.autoRegister==!1){if(!this.#e.has(e))return s}else this.registerEvents(e);let r=this.#c(t);this.#u(e,r);let i=this;return function(){i.#h(e,r)}}onAny(e,t){this.autoRegister==!0&&this.registerEvents(...e);let s=Array.from(e).filter(i=>this.#e.has(i));if(s.length==0)return()=>{};let r=this.#c(t);return s.forEach(i=>{this.#u(i,r)}),()=>{s.forEach(i=>{this.#h(i,r)})}}removeListener(e,t){if(!this.#e.has(e))return;let s=this.#s(t);s!=-1&&this.#h(e,s)}removeAllListeners(e){if(!this.#e.has(e))return;(this.#e.get(e)||new Set).forEach(s=>{this.#h(e,s)})}off(e,t){this.removeListener(e,t)}hasEvent(e){return this.#e.has(e)}hasListeners(e){return(this.#e.get(e)||new Set).size>0}getNumberOfListeners(e){return(this.#e.get(e)||new Set).size}emit(e,...t){if(this.#n)throw new Error("Cannot call emit while listeners are running");this.#e.has(e)&&(this.#t?this.#r.set(e,t):this.#p(e,...t))}#p(e,...t){let s=this.#e.get(e)||new Set;this.#n=!0,s.forEach(r=>{try{let i=this.#o.get(r);i&&i(...t)}catch(i){console.error(e,t),console.error(i)}}),this.#n=!1}emitMany(e,...t){if(this.#n)throw new Error("Cannot call emitMany while listeners are running");e.forEach(s=>{this.#e.has(s)&&this.#r.set(s,t)}),this.#t||this.#f()}once(e,t){let s=this,r=this.on(e,function(){r(),t.apply(s,arguments)});return r}waitForEvent(e,t=0){return new Promise(s=>{let r,i=this.on(e,()=>{t>0&&clearTimeout(r),i(),s(!0)});t>0&&(r=setTimeout(()=>{i(),s(!1)},t))})}waitForAnyEvent(e,t=0){return new Promise(s=>{let r,i=[],n=()=>{t>0&&clearTimeout(r),i.forEach(h=>{h()}),s(!0)};e.forEach(h=>{i.push(this.on(h,n))}),t>0&&(r=setTimeout(()=>{n(),s(!1)},t))})}};var b=class{#e;#t;constructor(e,t,s){this.#t=e,this.#e=t,this.value=s}set value(e){this.#t.setItem(this.#e,e)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(e,t){return this.#t.subscribe(this.#e,e,t)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}setCompareFunction(e){return this.#t.setCompareFunction(this.#e,e)}get store(){return this.#t}onHasSubscribers(e){return this.#t.onHasSubscribers(this.#e,e)}onNoSubscribers(e){return this.#t.onNoSubscribers(this.#e,e)}};function v(o){return typeof o=="object"&&o!==null&&!Array.isArray(o)}function A(o,e){if(o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(!p(o[t],e[t]))return!1;return!0}function T(o,e){if(o===e)return!0;if(!v(o)||!v(e))return!1;let t=Object.keys(o),s=Object.keys(e);if(t.length!==s.length)return!1;for(let r=0;r<t.length;r++){let i=t[r];if(!Object.prototype.hasOwnProperty.call(e,i)||!p(o[i],e[i]))return!1}return!0}function p(o,e){return o===e?!0:typeof o!=typeof e||o===null||e===null||o===void 0||e===void 0?!1:Array.isArray(o)||Array.isArray(e)?Array.isArray(o)&&Array.isArray(e)?A(o,e):!1:T(o,e)}function I(o,e){var t,s=(...r)=>{var i=this,n=function(){t=null,o.apply(i,r)};clearTimeout(t),t=setTimeout(n,e)};return s}function y(o){var e=new Set;for(let t=0;t<o.length;t++)e.add(o[t]);return e}var E=class{#e;#t;constructor(e,t,s){this.#t=e,this.#e=t,typeof s<"u"&&this.#t.createCollectionItem(this.#e,s)}set value(e){this.#t.setItem(this.#e,e)}get value(){return this.#t.getItem(this.#e)}set content(e){this.#t.setItem(this.#e,e)}get content(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(e,t){return this.#t.subscribe(this.#e,e,t)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}get store(){return this.#t}updateItemValue(e,t){var s=this.#t.getItem(this.#e),r;v(s[e])?r={...s[e],...t}:r=t,s[e]=r}onHasSubscribers(e){return this.#t.onHasSubscribers(this.#e,e)}onNoSubscribers(e){return this.#t.onNoSubscribers(this.#e,e)}};var w=class{#e;#t;constructor(e,t,s,r={}){this.#t=e,this.#e=t,typeof s<"u"&&this.#t.createComputedItem(this.#e,s,r)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(e,t){return this.#t.subscribe(this.#e,e,t)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}recalc(){return this.#t.recalcComputed(this.#e)}get store(){return this.#t}onHasSubscribers(e){return this.#t.onHasSubscribers(this.#e,e)}onNoSubscribers(e){return this.#t.onNoSubscribers(this.#e,e)}setCompareFunction(e){return this.#t.setCompareFunction(this.#e,e)}};var f=class{value;old_value;item_name;eventType;property=null},R=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,S=class{#e=new Map;#t=new Map;#r=new Map;#d=new Map;#o=null;#i={};#n=!1;#l=!1;#c=[];#v=0;#s=new m;#u=!1;#h=new Set;#g=0;log=console.log;logError=console.error;warn=console.warn;constructor(){this.#s.autoRegister=!0}#f(e){return R.test(e)}#p(e,t){var s=void 0,r=this.#e.get(e);r&&(s=r.value);var i=!0;if(this.#i[e]?i=this.#i[e](s,t,e,null):i=p(s,t),!i){r.value=t,r.version++,this.#e.set(e,r);let n=new f;return n.eventType="set",n.item_name=e,n.value=t,n.old_value=s,this.#a(e,n),n}return!1}#y(e,t){if(!this.#f(e))throw new Error(`${e} is wrong store's item_name`);var s={version:0,value:t};this.#e.set(e,s)}#S(e,t,s){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();var r=this.#r.get(e);let i=r.value,n=i[t],h=!0;if(this.#i[e]?h=this.#i[e](n,s,e,t):h=p(n,s),h)return!1;i[t]=s;let l=new f;return l.eventType="set",l.item_name=e,l.property=t,l.value=s,l.old_value=n,r.version++,this.#a(e,l),l}#C(e,t){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();var s=this.#r.get(e),r=s.value,i=r[t];delete r[t];var n=new f;return n.eventType="delete",n.item_name=e,n.property=t,n.value=null,n.old_value=i,s.version++,this.#a(e,n),n}#A(e,t){Array.isArray(t)||(this.warn(`Cannot assign a non-array value to a collection. Now ${e} == [].`),t=[]);var s=this.#r.get(e),r=s.value,i=!0,n=r.length;if(n!=t.length){let l=new f;l.eventType="set",l.item_name=e,l.property="length",l.value=t.length,l.old_value=n,s.version++,this.#a(e,l)}if(r.length>t.length)for(let l=t.length;l<r.length;l++)this.#C(e,(r.length-l-1).toString())&&(i=!1);r.length=t.length;for(let l=0;l<t.length;l++)this.#S(e,l.toString(),t[l])&&(i=!1);if(i)return!1;let h=new f;return h.eventType="set",h.item_name=e,h.value=t,h.old_value=void 0,this.#a(e,h),this.#E([e]),h}hasItem(e){return e=="store"||this.#e.has(e)||this.#t.has(e)||this.#r.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}#E(e){var t=y(e),s=new Set;this.#t.forEach(n=>{this.#N(n,t,s)});var r=this,i=Array.from(s).filter(n=>r.hasSubscribers(n));i.forEach(n=>{let h=r.#t.get(n);h.stale&&r.#w(h.item_name)})}setItems(e){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t=[];for(let s in e){if(s=="store"||this.isComputedItem(s))continue;if(!this.hasItem(s)){if(this.#n){this.logError(`Store is sealed. Can't create the item "${s}"`);continue}this.#y(s,void 0)}let r=e[s],i;this.isAtomItem(s)&&(i=this.#p(s,r)),this.isCollection(s)&&(i=this.#A(s,r)),i&&t.push(s)}this.#E(t),this.#b()}isComputedItem(e){return this.#t.has(e)}isAtomItem(e){return this.#e.has(e)}isCollection(e){return this.#r.has(e)}#T(e){return e.map(t=>{var s=this.#e.get(t)||this.#r.get(t);if(s)return s.version;var r=this.#t.get(t);if(r){if(!r.stale)return r.version;var i=this.#m(r.item_name);return r.version}}).join(",")}#w(e){let t=this.#t.get(e);if(t===void 0)throw new Error(`#recalc error: ${e}`);let s=t.value;if(t.is_hard){let h=t.memo,l=this.#T(t.dependencies);if(h===l)return t.stale=!1,!1;t.memo=l}t.stale=!0;let r=t.getter();t.stale=!1;let i=!0;if(this.#i[e]?i=this.#i[e](s,r,e,null):i=p(s,r),i)return!1;t.value=r,t.version++;let n=new f;return n.eventType="set",n.item_name=e,n.value=r,n.old_value=s,this.#a(e,n),n}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#w(e);return t&&this.#b(),t}#O(e,t,s={}){let r=this;var i=()=>{try{return t(r)}catch(d){return this.logError(`Computed error ${e}: `,d),"#ERROR!"}},n=this.getUsedItems(i),h=n.value,l=n.items,u=n.items.filter(d=>this.isComputedItem(d));if(u.forEach(d=>{this.#t.get(d)?.influences.add(e)}),l.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);var c=s.hasOwnProperty("is_hard")?s.is_hard:!1,a="";c&&(a=this.#T(l)),this.#t.set(e,{item_name:e,dependencies:l,influences:new Set,getter:i,value:h,stale:!1,memo:a,is_hard:c,version:0})}#N(e,t,s){if(e.stale)return!0;for(var r=e.dependencies,i=e.dependencies.filter(u=>this.#t.has(u)),n=0;n<r.length;n++)t.has(r[n])&&(e.stale=!0,s.add(e.item_name));var h=this;function l(u){u.influences.forEach(c=>{let a=h.#t.get(c);a&&(a.stale||(a.stale=!0,s.add(c),a.influences.size>0&&l(a)))})}return i.forEach(u=>{let c=h.#t.get(u);c&&l(c)}),!1}#x(e,t,s=!1,r={}){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!s&&!this.#f(e))throw new Error(`${e} is wrong store's item_name`);return this.#O(e,t,r),!0}createComputedItem(e,t,s={}){return this.#n?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#x(e,t,!1,s)}createCollectionItem(e,t){if(e=e.trim(),this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#f(e))throw new Error(`${e} is wrong store's item_name`);var s=this,r=new Proxy(t,{deleteProperty:function(i,n){let h=i.length;return typeof n=="symbol"?delete i[n]:typeof n=="string"&&s.#C(e,n)&&(delete i[n],s.#E([e]),s.#b()),!0},set:function(i,n,h,l){if(typeof n=="symbol")i[n]=h;else if(typeof n=="string"){let u=s.#r.get(e),c=u.value,a=parseInt(n),d=c.length;if(!isNaN(a)&&a>=c.length){let g=new f;g.eventType="set",g.item_name=e,g.property="length",g.value=a+1,g.old_value=d,s.#a(e,g),u.version++}s.#S(e,n,h)&&(i[n]=h,s.#E([e]),s.#b())}return!0}});return s.#r.set(e,{version:0,value:t}),s.#d.set(e,r),r}onChange(e){return this.#s.on("#change",e)}onChangeAny(e,t){let s=[];for(let n=0;n<e.length;n++){let h=e[n];if(typeof h=="string"){this.hasItem(h)&&s.push(h);continue}(h instanceof b||h instanceof w||h instanceof E)&&h.store===this&&s.push(h.name)}if(s.length==0)return;let r=this;return this.#s.on("#change",function(n){let h=!1,l={};for(let u in n)if(s.indexOf(u)>-1){h=!0,l[u]=n[u];break}h&&t(l,r)})}deleteItem(e){if(this.#n)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new f;return s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#t.delete(e),this.isAtomItem(e)&&this.#e.delete(e),this.isCollection(e)&&(this.#r.delete(e),this.#d.delete(e)),this.#a(e,s),this.#b(),!0}#R(){return Object.fromEntries(this.#e)}getItems(e=!1){return e?Object.assign({},this.#R(),this.#D()):this.#R()}#m(e){this.#u&&this.#h.add(e);let t=this.#t.get(e);if(t===void 0)throw new Error(`#getComputedValue error: ${e}`);t.stale&&this.#w(e);let s=this.#t.get(e);if(s===void 0)throw new Error(`#getComputedValue error: ${e}`);return s.value}#L(e){return this.#u&&this.#h.add(e),this.#d.get(e)}#D(){let e={};return this.#t.forEach(t=>{e[t.item_name]=this.#m(t.item_name)}),e}#j(e){this.#u&&this.#h.add(e);var t=this.#e.get(e),s=t?t.value:void 0;return s}getItem(e){if(e=="store")return this;if(this.hasItem(e)){if(this.isAtomItem(e))return this.#j(e);if(this.isComputedItem(e))return this.#m(e);if(this.isCollection(e))return this.#L(e)}}getItemNames(){let e=[];return this.#e.forEach((t,s)=>{e.push(s)}),this.#t.forEach((t,s)=>{e.push(s)}),this.#r.forEach((t,s)=>{e.push(s)}),e}subscribe(e,t,s){s===void 0&&(s=this.#v);var r=s<=0?t:I(t,s);let i=this.#s.on(e,r);return this.#s.getNumberOfListeners(e)==1&&this.#s.emit("#has-subscribers:"+e,e,this),()=>{i(),this.#s.getNumberOfListeners(e)==0&&this.#s.emit("#no-subscribers:"+e,e,this)}}hasSubscribers(e){return this.#s.hasListeners(e)}clearSubscribers(){this.#s.unregisterAllEvents()}clearItemSubscribers(e){let t=!1,s=this.#s.getNumberOfListeners(e);s!=0&&(s>0&&(t=!0),this.#s.removeAllListeners(e),t&&this.#s.emit("#no-subscribers:"+e))}reset(){this.#e.clear(),this.#t.clear(),this.#r.clear(),this.clearSubscribers()}asObject(){return this.#o||(this.#o=this.#$()),this.#o}#$(){let e={},t=this,s={get(r,i){return typeof i=="string"?t.getItem(i):null},set(r,i,n){return t.setItems({[i]:n}),!0},ownKeys(r){return t.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,i){return typeof i=="string"&&t.deleteItem(i),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#i[e]=t,!0):!1}isSealed(){return this.#n}seal(){this.#n=!0}unseal(){this.#n=!1}#a(e,t){this.#c.push([e,t])}#b(){if(!this.#l){this.#l=!0;for(var e={},t=0;t<this.#c.length;){let s=this.#c[t];this.#s.emit(s[0],s[1],this),t++,e[s[0]]||(e[s[0]]=[]),e[s[0]].push(s[1])}this.#s.emit("#change",e,this),this.#c=[],this.#l=!1,this.#s.emit("#reactions_finished",this)}}setDebounceTime(e){this.#v=e<0?0:e}next(e){this.#l?this.#s.once("#reactions_finished",e):e(this)}#I(){for(;this.hasItem("_"+this.#g);)this.#g++;return"_"+this.#g}createAtom(e,t){return typeof t>"u"&&(t=this.#I()),new b(this,t,e)}createAtomItem(e,t){this.setItem(e,t)}getAtom(e){if(this.isAtomItem(e))return new b(this,e,this.getItem(e));throw new Error(`Unknown atom ${e}`)}createComputed(e,t,s={}){return typeof t>"u"&&(t=this.#I()),new w(this,t,e,s)}getComputed(e){if(!this.isComputedItem(e))throw new Error(`Unknown computed ${e}`);return new w(this,e)}createCollection(e,t){return typeof t>"u"&&(t=this.#I()),new E(this,t,e)}getCollection(e){if(this.isCollection(e))return new E(this,e);throw new Error(`Unknown collection ${e}`)}observeObject(e){if(!v(e))throw new Error(`obj must have an object type. obj = ${e}`);let t=this,s={store:{get(){return t}}};for(let r in e){let i=e[r];if(i instanceof Function||typeof i=="symbol"||(s[r]={get(){return t.getItem(r)},set(n){t.setItem(r,n)}}),this.hasItem(r)){if(this.isCollection(r)){let n=Array.isArray(i)?i:[];this.#A(r,n);continue}if(this.isAtomItem(r)){this.#p(r,i);continue}}else{if(Array.isArray(i)){this.createCollectionItem(r,i);continue}if(i instanceof Function||typeof i=="symbol")continue;this.#y(r,i);continue}}return Object.defineProperties(e,s),e}getUsedItems(e){this.#h.clear(),this.#u=!0;let t=e();var s=Array.from(this.#h);return this.#u=!1,this.#h.clear(),{value:t,items:s}}autorun(e,t={}){return this.createComputed(e,void 0,t).subscribe(()=>{})}reaction(e,t,s={}){var r=this.getUsedItems(e);if(r.items.length>0)return this.createComputed(e,void 0,s).subscribe(t)}when(e,t){var s=this.getUsedItems(e);return t?this.onChangeAny(s.items,()=>{try{e()&&t()}catch(r){this.logError(r)}}):new Promise((r,i)=>{var n=this.onChangeAny(s.items,()=>{let h=e();h&&(n&&n(),r(h))})})}onHasSubscribers(e,t){return this.#s.on("#has-subscribers:"+e,t)}onNoSubscribers(e,t){return this.#s.on("#no-subscribers:"+e,t)}};export{b as Atom,E as Collection,w as Computed,S as Store,f as UpdateEventDetails,I as debounce};
