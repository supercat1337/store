var g=class{events={};on(t,e){typeof this.events[t]!="object"&&(this.events[t]=[]),this.events[t].push(e);let s=this;return function(){s.removeListener(t,e)}}removeListener(t,e){var s;typeof this.events[t]=="object"&&(s=this.events[t].indexOf(e),s>-1&&this.events[t].splice(s,1))}emit(t){if(typeof this.events[t]=="object"){var e,s,r,i=[].slice.call(arguments,1);for(s=this.events[t].slice(),r=s.length,e=0;e<r;e++)try{s[e].apply(this,i)}catch(n){console.error(t,i),console.error(n)}}}once(t,e){return this.on(t,function s(){this.removeListener(t,s),e.apply(this,arguments)})}};var f=class{#e;#t;constructor(t,e,s){this.#t=t,this.#e=e,typeof s<"u"&&(this.value=s)}set value(t){this.#t.setItem(this.#e,t)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(t,e){return this.#t.subscribe(this.#e,t,e)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}setCompareFunction(t){return this.#t.setCompareFunction(this.#e,t)}get store(){return this.#t}};var c=class{#e;#t;constructor(t,e,s){this.#t=t,this.#e=e,typeof s<"u"&&this.#t.createCollectionItem(this.#e,s)}set value(t){this.#t.setItem(this.#e,t)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(t,e){return this.#t.subscribe(this.#e,t,e)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}get store(){return this.#t}};var d=class{#e;#t;constructor(t,e,s){this.#t=t,this.#e=e,typeof s<"u"&&this.#t.createComputedItem(this.#e,s)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(t,e){return this.#t.subscribe(this.#e,t,e)}clearSubscribers(){return this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){return this.#t.hasSubscribers(this.#e)}recalc(){return this.#t.recalcComputed(this.#e)}get store(){return this.#t}};function p(h,t){if(h===t)return!0;if(h===null||t===null||h===void 0||t===void 0||typeof h!=typeof t)return!1;if(Array.isArray(h)||Array.isArray(t))return JSON.stringify(h)===JSON.stringify(t);let e=JSON.stringify(h,Object.keys(h).sort()),s=JSON.stringify(t,Object.keys(t).sort());return e===s}function w(h,t){var e,s=(...r)=>{var i=this,n=function(){e=null,h.apply(i,r)};clearTimeout(e),e=setTimeout(n,t)};return s}function I(h){return typeof h=="object"&&!Array.isArray(h)&&h!==null}var a=class{value;old_value;item_name;eventType;property=null},y=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,b=class{#e=new Map;#t=new Map;#r=new Map;#g=new Map;#p=null;#n={};#o=!1;#l=!1;#f=[];#y=0;#s=new g;#u=!1;#h=new Set;#v=0;log=console.log;logError=console.error;warn=console.warn;constructor(t){if(t)for(let e in t){let s=t[e];if(s==null){this.#c(e,s);continue}if(Array.isArray(s)){this.createCollection(s,e);continue}s instanceof Function||this.#c(e,s)}}#b(t){return y.test(t)}#C(t,e){let s=this.#e.get(t);this.#e.set(t,e);let r=!0;if(this.#n[t]?r=this.#n[t](s,e,t,null):r=p(s,e),!r){let i=new a;return i.eventType="set",i.item_name=t,i.value=e,i.old_value=s,this.#i(t,i),i}return!1}#c(t,e){if(!this.#b(t))throw new Error(`${t} is wrong store's item_name`);this.#e.set(t,e)}#m(t,e,s){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");e=e.toString();let r=this.#r.get(t)||[],i=r[e],n=!0;if(this.#n[t]?n=this.#n[t](i,s,t,e):n=p(i,s),n)return!1;let l=r.length;if(r[e]=s,l!=r.length){let u=new a;u.eventType="set",u.item_name=t,u.property="length",u.value=s,u.old_value=i,this.#i(t,u)}let o=new a;return o.eventType="set",o.item_name=t,o.property=e,o.value=s,o.old_value=i,this.#i(t,o),o}#A(t,e){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");e=e.toString();let s=this.#r.get(t);if(s===void 0)throw new Error(`#deleteCollectionItem error: ${t}`);let r=s[e];delete s[e];let i=new a;return i.eventType="delete",i.item_name=t,i.property=e,i.value=null,i.old_value=r,this.#i(t,i),i}#E(t,e){Array.isArray(e)||(this.warn(`Cannot assign a non-array value to a collection. Now ${t} == [].`),e=[]);let s=this.#r.get(t)||[],r=!0,i=s.length;if(s.length>e.length)for(let l=e.length;l<s.length;l++)this.#A(t,(s.length-l-1).toString())&&(r=!1);s.length=e.length;for(let l=0;l<e.length;l++)this.#m(t,l.toString(),e[l])&&(r=!1);if(r)return!1;let n=new a;if(n.eventType="set",n.item_name=t,n.value=e,n.old_value=void 0,i!=e.length){let l=new a;l.eventType="set",l.item_name=t,l.property="length",l.value=e.length,l.old_value=i,this.#i(t,l)}return this.#i(t,n),this.#d([t]),n}hasItem(t){return t=="store"||this.#e.has(t)||this.#t.has(t)||this.#r.has(t)}setItem(t,e){var s={[t]:e};this.setItems(s)}#d(t){var e=new Set;for(let s=0;s<t.length;s++)e.add(t[s]);this.#t.forEach(s=>{!this.#O(s,e)||!this.hasSubscribers(s.item_name)||this.#w(s.item_name)})}setItems(t){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var e=[];for(let s in t){if(s=="store"||this.isComputedItem(s))continue;if(!this.hasItem(s)){if(this.#o){this.logError(`Store is sealed. Can't create the item "${s}"`);continue}this.#c(s,void 0)}let r=t[s],i;this.isAtomItem(s)&&(i=this.#C(s,r)),this.isCollection(s)&&(i=this.#E(s,r)),i&&e.push(s)}this.#d(e),this.#a()}isComputedItem(t){return this.#t.has(t)}isAtomItem(t){return this.#e.has(t)}isCollection(t){return this.#r.has(t)}#w(t){let e=this.#t.get(t);if(e===void 0)throw new Error(`#recalc error: ${t}`);let s=e.value;e.stale=!0;let r=e.getter();e.stale=!1;let i=!0;if(this.#n[t]?i=this.#n[t](s,r,t,null):i=p(s,r),i)return!1;e.value=r;let n=new a;return n.eventType="set",n.item_name=t,n.value=r,n.old_value=s,this.#i(t,n),n}recalcComputed(t){if(!this.isComputedItem(t))return!1;let e=this.#w(t);return e&&this.#a(),e}#j(t,e){let s=this;var r=()=>{try{return e(s)}catch(o){return this.logError(`Computed error ${t}: `,o),"#ERROR!"}},i=this.getUsedItems(r),n=i.value,l=i.items.filter(o=>this.isAtomItem(o)||this.isCollection(o));if(l.length==0)throw new Error(`Computed item ${t} hasn't dependencies`);this.#t.set(t,{item_name:t,dependencies:l,getter:r,value:n,stale:!1})}#O(t,e){for(var s=t.dependencies,r=0;r<s.length;r++)if(e.has(s[r]))return t.stale=!0,!0;return!1}#S(t,e,s=!1){if(t=t.trim(),this.hasItem(t))return this.warn(`Item name ${t} name already exists`),!1;if(!s&&!this.#b(t))throw new Error(`${t} is wrong store's item_name`);return this.#j(t,e),!0}createComputedItem(t,e){return this.#o?(this.logError(`Store is sealed. Can't create the item "${t}"`),!1):this.#S(t,e)}loadExpression(t){t=t.trim();let e=`{${t}}`;if(this.hasItem(e))return e;var s=new Set,r=t,i=r.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let u of i){let v=u[0].slice(1);this.hasItem(v)&&s.add(v)}var n=Array.from(s),l=n.map(u=>`var $${u} = store.getItem("${u}");`).join(`
`),o=new Function("store",`
    ${l}
    return ${t};
`);return this.#S(e,o,n,!0),e}createCollectionItem(t,e){t=t.trim();var s=e.length;if(this.hasItem(t))throw new Error(`Item name ${t} name already exists`);if(!this.#b(t))throw new Error(`${t} is wrong store's item_name`);var r=this,i=new Proxy(e,{deleteProperty:function(n,l){let o=n.length;return typeof l=="symbol"?delete n[l]:typeof l=="string"&&r.#A(t,l)&&(delete n[l],r.#d([t]),r.#a()),!0},set:function(n,l,o,u){return typeof l=="symbol"?n[l]=o:typeof l=="string"&&r.#m(t,l,o)&&(n[l]=o,r.#d([t]),r.#a()),!0}});return r.#r.set(t,e),r.#g.set(t,i),i}onChange(t){return this.#s.on("#change",t)}onChangeAny(t,e){let s=[];for(let n=0;n<t.length;n++){let l=t[n];if(typeof l=="string"){this.hasItem(l)&&s.push(l);continue}(l instanceof f||l instanceof d||l instanceof c)&&l.store===this&&s.push(l.name)}if(s.length==0)return;let r=this;return this.#s.on("#change",function(n){let l=!1,o={};for(let u in n)if(s.indexOf(u)>-1){l=!0,o[u]=n[u];break}l&&e(o,r)})}deleteItem(t){if(this.#o)return this.logError(`Store is sealed. Can't delete the item "${t}"`),!1;if(!this.hasItem(t))return!1;let e=this.getItem(t),s=new a;return s.eventType="delete",s.item_name=t,s.value=e,this.clearItemSubscribers(t),this.isComputedItem(t)&&this.#t.delete(t),this.isAtomItem(t)&&this.#e.delete(t),this.isCollection(t)&&(this.#r.delete(t),this.#g.delete(t)),this.#i(t,s),this.#a(),!0}#$(){return Object.fromEntries(this.#e)}getItems(t=!1){return t?Object.assign({},this.#$(),this.#U()):this.#$()}#x(t){this.#u&&this.#h.add(t);let e=this.#t.get(t);if(e===void 0)throw new Error(`#getComputedValue error: ${t}`);e.stale&&this.#w(t);let s=this.#t.get(t);if(s===void 0)throw new Error(`#getComputedValue error: ${t}`);return s.value}#T(t){return this.#u&&this.#h.add(t),this.#g.get(t)}#U(){let t={};return this.#t.forEach(e=>{t[e.item_name]=this.#x(e.item_name)}),t}#k(t){return this.#u&&this.#h.add(t),this.#e.get(t)}getItem(t){if(t=="store")return this;if(this.hasItem(t)){if(this.isAtomItem(t))return this.#k(t);if(this.isComputedItem(t))return this.#x(t);if(this.isCollection(t))return this.#T(t)}}getItemNames(){let t=[];return this.#e.forEach((e,s)=>{t.push(s)}),this.#t.forEach((e,s)=>{t.push(s)}),this.#r.forEach((e,s)=>{t.push(s)}),t}subscribe(t,e,s){s===void 0&&(s=this.#y);var r=s<=0?e:w(e,s);return this.#s.on(t,r)}hasSubscribers(t){let e=this.#s.events[t];return e?e.length>0:!1}clearSubscribers(){this.#s.events={}}clearItemSubscribers(t){delete this.#s.events[t]}reset(){this.#e.clear(),this.#t.clear(),this.#r.clear(),this.clearSubscribers()}asObject(){return this.#p||(this.#p=this.#N()),this.#p}#N(){let t={},e=this,s={get(r,i){return typeof i=="string"?e.getItem(i):null},set(r,i,n){return e.setItems({[i]:n}),!0},ownKeys(r){return e.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,i){return typeof i=="string"&&e.deleteItem(i),!0}};return new Proxy(t,s)}setCompareFunction(t,e){return this.hasItem(t)?(this.#n[t]=e,!0):!1}isSealed(){return this.#o}seal(){this.#o=!0}unseal(){this.#o=!1}#i(t,e){this.#f.push([t,e])}#a(){if(!this.#l){this.#l=!0;for(var t={},e=0;e<this.#f.length;){let s=this.#f[e];this.#s.emit(s[0],s[1],this),e++,t[s[0]]||(t[s[0]]=[]),t[s[0]].push(s[1])}this.#s.emit("#change",t,this),this.#f=[],this.#l=!1,this.#s.emit("#reactions_finished",this)}}setDebounceTime(t){this.#y=t<0?0:t}next(t){this.#l?this.#s.once("#reactions_finished",t):t(this)}#I(){for(;this.hasItem("_"+this.#v);)this.#v++;return"_"+this.#v}createAtom(t,e){return typeof e>"u"&&(e=this.#I()),new f(this,e,t)}getAtom(t){if(this.isAtomItem(t))return new f(this,t);throw new Error(`Unknown atom ${t}`)}createComputed(t,e){return typeof e>"u"&&(e=this.#I()),new d(this,e,t)}getComputed(t){if(this.isComputedItem(t))return new d(this,t);throw new Error(`Unknown computed ${t}`)}createCollection(t,e){return typeof e>"u"&&(e=this.#I()),new c(this,e,t)}getCollection(t){if(this.isCollection(t))return new c(this,t);throw new Error(`Unknown collection ${t}`)}observeObject(t){if(!I(t))throw new Error(`obj must have an object type. obj = ${t}`);let e=this,s={store:{get(){return e}}};for(let r in t){let i=t[r];if(i instanceof Function||typeof i=="symbol"||(s[r]={get(){return e.getItem(r)},set(n){e.setItem(r,n)}}),this.hasItem(r)){if(this.isCollection(r)){let n=Array.isArray(i)?i:[];this.#E(r,n);continue}if(this.isAtomItem(r)){this.#C(r,i);continue}}else{if(Array.isArray(i)){this.createCollectionItem(r,i);continue}if(i instanceof Function||typeof i=="symbol")continue;this.#c(r,i);continue}}return Object.defineProperties(t,s),t}getUsedItems(t){this.#h.clear(),this.#u=!0;let e=t();var s=Array.from(this.#h);return this.#u=!1,this.#h.clear(),{value:e,items:s}}autorun(t){var e=this.getUsedItems(t);if(e.items.length>0)return this.onChangeAny(e.items,t)}reaction(t,e){var s=this.getUsedItems(t);if(s.items.length>0)return this.onChangeAny(s.items,e)}when(t,e){var s=this.getUsedItems(t);return e?this.onChangeAny(s.items,()=>{try{t()&&e()}catch(r){this.logError(r)}}):new Promise((r,i)=>{var n=this.onChangeAny(s.items,()=>{let l=t();l&&(n&&n(),r(l))})})}};function Z(h){return new b(h)}export{g as EventEmitter,b as Store,a as UpdateEventDetails,Z as createStore,w as debounce};
