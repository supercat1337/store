// version 1.0.5
var c=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,l,i=[].slice.call(arguments,1);for(s=this.events[e].slice(),l=s.length,t=0;t<l;t++)try{s[t].apply(this,i)}catch(r){console.error(e,i),console.error(r)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};function d(h,e){if(h===e)return!0;if(h===null||e===null||h===void 0||e===void 0||typeof h!=typeof e)return!1;if(Array.isArray(h)||Array.isArray(e))return JSON.stringify(h)===JSON.stringify(e);let t=JSON.stringify(h,Object.keys(h).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function p(h,e){var t;return function(){var s=this,l=arguments,i=function(){t=null,h.apply(s,l)};clearTimeout(t),t=setTimeout(i,e)}}var f=class{value;old_value;item_name;eventType;property=null},b=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,g=class{#t=new Map;#e=new Map;#s=new Map;#f=null;#i={};#l=!1;#n=!1;#h=[];#g=0;#r=new c;log=console.log;logError=console.error;warn=console.warn;constructor(e){e&&this.setItems(e)}#c(e){return b.test(e)}#y(e,t){let s=this.#t.get(e);this.#t.set(e,t);let l=!0;if(this.#i[e]?l=this.#i[e](s,t,e,null):l=d(s,t),!l){let i=new f;return i.eventType="set",i.item_name=e,i.value=t,i.old_value=s,i}return!1}#m(e,t){if(!this.#c(e))throw new Error(`${e} is wrong store's item_name`);this.#t.set(e,t)}#v(e,t,s){if(this.#n)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let l=this.#s.get(e),i=l[t],r=!0;if(this.#i[e]?(r=this.#i[e](i,s,e,t),this.log(r,i,s,e,t)):r=d(i,s),r)return!1;l[t]=s;let n=new f;return n.eventType="set",n.item_name=e,n.property=t,n.value=s,n.old_value=i,n}#p(e,t){if(this.#n)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let s=this.#s.get(e),l=s[t];delete s[t];let i=new f;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=l,i}#C(e,t){let s=this.#s.get(e),l=!0,i=[];if(s.length>t.length)for(let n=t.length;n<s.length;n++){let o=this.#p(e,n.toString());o&&(i.push(o),l=!1)}s.length=t.length;for(let n=0;n<t.length;n++){let o=this.#v(e,n.toString(),t[n]);o&&(i.push(o),l=!1)}if(l)return!1;let r=new f;return r.eventType="set",r.item_name=e,r.value=t,{main_details:r,details_arr:i}}hasItem(e){return this.#t.has(e)||this.#e.has(e)||this.#s.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}setItems(e){if(this.#n)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t={},s=[],l=!1,i=new Set;for(let r in e){if(r=="store"||this.isComputedItem(r))continue;if(!this.hasItem(r)){if(this.#l){this.logError(`Store is sealed. Can't create the item "${r}"`);continue}this.#m(r,void 0)}let n=e[r],o=this.isAtomItem(r),u=this.isCollection(r);if(o){let a=this.#y(r,n);if(a==!1)continue;l=!0,t[r]=a,s.push(a),i.add(r)}if(u){let a=this.#C(r,n);if(a==!1)continue;l=!0;let{main_details:v,details_arr:w}=a;t[r]=v,s.push(...w,v),i.add(r)}}if(l){this.#e.forEach(r=>{if(!this.#E(r,i)||!this.hasSubscribers(r.item_name))return;let o=this.#d(r.item_name);o!==!1&&(t[r.item_name]=o,s.push(o))});for(let r=0;r<s.length;r++){let n=s[r];this.#o(n.item_name,n)}this.#u(t,"set"),this.#a()}}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#t.has(e)}isCollection(e){return this.#s.has(e)}#d(e){let t=this.#e.get(e),s=this,l=t.value;t.stale=!0;let i=t.getter();t.stale=!1;let r=!0;if(this.#i[e]?r=this.#i[e](l,i,e,null):r=d(l,i),r)return!1;t.value=i;let n=new f;return n.eventType="set",n.item_name=e,n.value=i,n.old_value=l,n}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#d(e);return t&&this.hasSubscribers(e)&&(this.#o(e,t),this.#a()),t}#A(e,t,s){let l=this;if(s.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);var i=()=>{try{return t(l)}catch(r){return this.logError(`Computed error ${e}: `,r),"#ERROR!"}};this.#e.set(e,{item_name:e,dependencies:s,getter:i,value:i(),stale:!1})}#E(e,t){for(var s=e.dependencies,l=0;l<s.length;l++)if(t.has(s[l]))return e.stale=!0,!0;return!1}#w(e,t,s,l=!1){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!l&&!this.#c(e))throw new Error(`${e} is wrong store's item_name`);let i=new Set;for(let r=0;r<s.length;r++){let n=s[r];if(!this.hasItem(n)){this.warn(`${e}: Unknown dependency ${n} is ignored`);continue}if(!this.isAtomItem(n)){this.warn(`${e}: The non-atom item ${n} is ignored`);continue}i.add(n)}return this.#A(e,t,Array.from(i)),!0}createComputedItem(e,t,s){return this.#l?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#w(e,t,s)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,l=e,i=l.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let u of i){let a=u[0].slice(1);this.hasItem(a)&&s.add(a)}var r=Array.from(s),n=r.map(u=>`var $${u} = store.getItem("${u}");`).join(`
`),o=new Function("store",`
    ${n}
    return ${e};
`);return this.#w(t,o,r,!0),t}createCollection(e,t){if(e=e.trim(),this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#c(e))throw new Error(`${e} is wrong store's item_name`);var s=this,l=new Proxy(t,{deleteProperty:function(i,r){if(typeof r=="symbol")delete i[r];else if(typeof r=="string"){let n=s.#p(e,r);n&&(delete i[r],s.#o(n.item_name,n),s.#u({[e]:n},"delete"),s.#a())}return!0},set:function(i,r,n,o){if(typeof r=="symbol")i[r]=n;else if(typeof r=="string"){let u=s.#v(e,r,n);u&&(i[r]=n,s.#o(u.item_name,u),s.#u({[e]:u},"set"),s.#a())}return!0}});return s.#s.set(e,t),l}onChange(e){return this.#r.on("#change",e)}onChangeAny(e,t){if(e.length==0)return;let s=this;return this.#r.on("#change",function(i){let r=i.details,n=!1;for(let o in r)if(e.indexOf(o)>-1){n=!0;break}n&&t(i,s)})}deleteItem(e){if(this.#l)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new f;s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#t.delete(e),this.isCollection(e)&&this.#s.delete(e),this.#u({[e]:s},"delete")}#b(){return Object.fromEntries(this.#t)}getItems(e=!1){return e?Object.assign({},this.#b(),this.#$()):this.#b()}#I(e){return this.#e.get(e).stale&&this.#d(e),this.#e.get(e).value}#S(e){return this.#s.get(e)}#$(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#I(t.item_name)}),e}#x(e){return this.#t.get(e)}getItem(e){if(e=="store")return this;if(!this.hasItem(e))return null;if(this.isAtomItem(e))return this.#x(e);if(this.isComputedItem(e))return this.#I(e);if(this.isCollection(e))return this.#S(e)}getItemNames(){return[].concat(Array.from(this.#t.keys()),Array.from(this.#e.keys()),Array.from(this.#s.keys()))}subscribe(e,t,s){s===void 0&&(s=this.#g);var l=s<=0?t:p(t,s);return this.#r.on(e,l)}hasSubscribers(e){let t=this.#r.events[e];return t?t.length>0:!1}clearSubscribers(){this.#r.events={}}clearItemSubscribers(e){delete this.#r.events[e]}reset(){this.#t.clear(),this.#e.clear(),this.#s.clear(),this.clearSubscribers()}#u(e,t=null){let s={details:e,eventType:t};this.#o("#change",s)}asObject(){return this.#f||(this.#f=this.#O()),this.#f}#O(){let e={},t=this,s={get(l,i){return typeof i=="string"?t.getItem(i):null},set(l,i,r){return t.setItems({[i]:r}),!0},ownKeys(l){return t.getItemNames()},getOwnPropertyDescriptor(l){return{enumerable:!0,configurable:!0}},deleteProperty:function(l,i){return typeof i=="string"&&t.deleteItem(i),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#i[e]=t,!0):!1}isSealed(){return this.#l}seal(){this.#l=!0}unseal(){this.#l=!1}#o(e,t){this.#h.push([e,t])}#a(){if(!this.#n){this.#n=!0;for(var e=0;e<this.#h.length;){let t=this.#h[e];this.#r.emit(t[0],t[1],this),e++}this.#h=[],this.#n=!1,this.#r.emit("#reactions_finished",this)}}setDebounceTime(e){this.#g=e<0?0:e}next(e){this.#n?this.#r.once("#reactions_finished",e):e(this)}};function A(h){return new g(h)}export{c as EventEmitter,g as Store,f as UpdateEventDetails,A as createStore,p as debounce};
