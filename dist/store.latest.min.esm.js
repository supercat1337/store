// version 1.0.6
var b=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,r,i=[].slice.call(arguments,1);for(s=this.events[e].slice(),r=s.length,t=0;t<r;t++)try{s[t].apply(this,i)}catch(l){console.error(e,i),console.error(l)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};var d=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&(this.value=s)}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}setCompareFunction(e){return this.#e.setCompareFunction(this.#t,e)}get store(){return this.#e}};var g=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createCollectionItem(this.#t,s)}set value(e){this.#e.setItem(this.#t,e)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}get store(){return this.#e}};var p=class{#t;#e;constructor(e,t,s){this.#e=e,this.#t=t,typeof s<"u"&&this.#e.createComputedItem(this.#t,s)}get value(){return this.#e.getItem(this.#t)}get name(){return this.#t}subscribe(e,t){return this.#e.subscribe(this.#t,e,t)}clearSubscribers(){return this.#e.clearItemSubscribers(this.#t)}hasSubscribers(){return this.#e.hasSubscribers(this.#t)}recalc(){return this.#e.recalcComputed(this.#t)}get store(){return this.#e}};function v(u,e){if(u===e)return!0;if(u===null||e===null||u===void 0||e===void 0||typeof u!=typeof e)return!1;if(Array.isArray(u)||Array.isArray(e))return JSON.stringify(u)===JSON.stringify(e);let t=JSON.stringify(u,Object.keys(u).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function w(u,e){var t;return function(){var s=this,r=arguments,i=function(){t=null,u.apply(s,r)};clearTimeout(t),t=setTimeout(i,e)}}var c=class{value;old_value;item_name;eventType;property=null},y=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,I=class{#t=new Map;#e=new Map;#s=new Map;#p=new Map;#b=null;#l={};#u=!1;#n=!1;#f=[];#m=0;#r=new b;#c=!1;#a=new Set;#v=0;log=console.log;logError=console.error;warn=console.warn;constructor(e){e&&this.setItems(e)}#I(e){return y.test(e)}#$(e,t){let s=this.#t.get(e);this.#t.set(e,t);let r=!0;if(this.#l[e]?r=this.#l[e](s,t,e,null):r=v(s,t),!r){let i=new c;return i.eventType="set",i.item_name=e,i.value=t,i.old_value=s,i}return!1}#O(e,t){if(!this.#I(e))throw new Error(`${e} is wrong store's item_name`);this.#t.set(e,t)}#y(e,t,s){if(this.#n)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let r=this.#s.get(e),i=r[t],l=!0;if(this.#l[e]?l=this.#l[e](i,s,e,t):l=v(i,s),l)return!1;r[t]=s;let n=new c;return n.eventType="set",n.item_name=e,n.property=t,n.value=s,n.old_value=i,n}#C(e,t){if(this.#n)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let s=this.#s.get(e),r=s[t];delete s[t];let i=new c;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=r,i}#j(e,t){let s=this.#s.get(e),r=!0,i=[],l=s.length;if(s.length>t.length)for(let h=t.length;h<s.length;h++){let o=this.#C(e,h.toString());o&&(i.push(o),r=!1)}s.length=t.length;for(let h=0;h<t.length;h++){let o=this.#y(e,h.toString(),t[h]);o&&(i.push(o),r=!1)}if(r)return!1;let n=new c;if(n.eventType="set",n.item_name=e,n.value=t,l!=t.length){let h=new c;h.eventType="set",h.item_name=e,h.property="length",h.value=t.length,h.old_value=l,this.#i(e,h),this.#h({[e]:h},"set"),this.#d(e,!1)}return{main_details:n,details_arr:i}}hasItem(e){return this.#t.has(e)||this.#e.has(e)||this.#s.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}#d(e,t=!0){var s={},r=new Set;r.add(e),this.#e.forEach(i=>{if(!this.#S(i,r)||!this.hasSubscribers(i.item_name))return;let n=this.#g(i.item_name);n!==!1&&(this.#i(n.item_name,n),s[i.item_name]=n)}),Object.keys(s).length>0&&(this.#h(s,"set"),t&&this.#o())}setItems(e){if(this.#n)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t={},s=[],r=!1,i=new Set;for(let l in e){if(l=="store"||this.isComputedItem(l))continue;if(!this.hasItem(l)){if(this.#u){this.logError(`Store is sealed. Can't create the item "${l}"`);continue}this.#O(l,void 0)}let n=e[l],h=this.isAtomItem(l),o=this.isCollection(l);if(h){let a=this.#$(l,n);if(a==!1)continue;r=!0,t[l]=a,s.push(a),i.add(l)}if(o){let a=this.#j(l,n);if(a==!1)continue;r=!0;let{main_details:f,details_arr:m}=a;t[l]=f,s.push(...m,f),i.add(l)}}if(r){this.#e.forEach(l=>{if(!this.#S(l,i)||!this.hasSubscribers(l.item_name))return;let h=this.#g(l.item_name);h!==!1&&(t[l.item_name]=h,s.push(h))});for(let l=0;l<s.length;l++){let n=s[l];this.#i(n.item_name,n)}this.#h(t,"set"),this.#o()}}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#t.has(e)}isCollection(e){return this.#s.has(e)}#g(e){let t=this.#e.get(e),s=this,r=t.value;t.stale=!0;let i=t.getter();t.stale=!1;let l=!0;if(this.#l[e]?l=this.#l[e](r,i,e,null):l=v(r,i),l)return!1;t.value=i;let n=new c;return n.eventType="set",n.item_name=e,n.value=i,n.old_value=r,n}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#g(e);return t&&this.hasSubscribers(e)&&(this.#i(e,t),this.#o()),t}#k(e,t){let s=this;var r=()=>{try{return t(s)}catch(n){return this.logError(`Computed error ${e}: `,n),"#ERROR!"}};this.#a.clear(),this.#c=!0;let i=r();var l=Array.from(this.#a);if(l.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);this.#c=!1,this.#a.clear(),this.#e.set(e,{item_name:e,dependencies:l,getter:r,value:i,stale:!1})}#S(e,t){for(var s=e.dependencies,r=0;r<s.length;r++)if(t.has(s[r]))return e.stale=!0,!0;return!1}#A(e,t,s=!1){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!s&&!this.#I(e))throw new Error(`${e} is wrong store's item_name`);return this.#k(e,t),!0}createComputedItem(e,t){return this.#u?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#A(e,t)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,r=e,i=r.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let o of i){let a=o[0].slice(1);this.hasItem(a)&&s.add(a)}var l=Array.from(s),n=l.map(o=>`var $${o} = store.getItem("${o}");`).join(`
`),h=new Function("store",`
    ${n}
    return ${e};
`);return this.#A(t,h,l,!0),t}createCollectionItem(e,t){e=e.trim();var s=t.length;if(this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#I(e))throw new Error(`${e} is wrong store's item_name`);var r=this,i=new Proxy(t,{deleteProperty:function(l,n){let h=l.length;if(typeof n=="symbol")delete l[n];else if(typeof n=="string"){let o=r.#C(e,n);o&&(delete l[n],r.#i(o.item_name,o),r.#h({[e]:o},"delete"),r.#d(e),r.#o())}return!0},set:function(l,n,h,o){if(typeof n=="symbol")l[n]=h;else if(typeof n=="string"){let a=r.#y(e,n,h);if(a){if(l[n]=h,s!=l.length){let f=new c;f.eventType="set",f.item_name=e,f.property="length",f.value=l.length,f.old_value=s,s=l.length,r.#i(e,f),r.#h({[e]:f},"set"),r.#d(e),r.#o()}r.#i(a.item_name,a),r.#h({[e]:a},"set"),r.#d(e),r.#o()}}return!0}});return r.#s.set(e,t),r.#p.set(e,i),i}onChange(e){return this.#r.on("#change",e)}onChangeAny(e,t){if(e.length==0)return;let s=this;return this.#r.on("#change",function(i){let l=i.details,n=!1;for(let h in l)if(e.indexOf(h)>-1){n=!0;break}n&&t(i,s)})}deleteItem(e){if(this.#u)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new c;s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#t.delete(e),this.isCollection(e)&&(this.#s.delete(e),this.#p.delete(e)),this.#h({[e]:s},"delete")}#E(){return Object.fromEntries(this.#t)}getItems(e=!1){return e?Object.assign({},this.#E(),this.#N()):this.#E()}#x(e){return this.#e.get(e).stale&&this.#g(e),this.#e.get(e).value}#T(e){return this.#c&&this.#a.add(e),this.#p.get(e)}#N(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#x(t.item_name)}),e}#F(e){return this.#c&&this.#a.add(e),this.#t.get(e)}getItem(e){if(e=="store")return this;if(!this.hasItem(e))return null;if(this.isAtomItem(e))return this.#F(e);if(this.isComputedItem(e))return this.#x(e);if(this.isCollection(e))return this.#T(e)}getItemNames(){return[].concat(Array.from(this.#t.keys()),Array.from(this.#e.keys()),Array.from(this.#s.keys()))}subscribe(e,t,s){s===void 0&&(s=this.#m);var r=s<=0?t:w(t,s);return this.#r.on(e,r)}hasSubscribers(e){let t=this.#r.events[e];return t?t.length>0:!1}clearSubscribers(){this.#r.events={}}clearItemSubscribers(e){delete this.#r.events[e]}reset(){this.#t.clear(),this.#e.clear(),this.#s.clear(),this.clearSubscribers()}#h(e,t=null){let s={details:e,eventType:t};this.#i("#change",s)}asObject(){return this.#b||(this.#b=this.#P()),this.#b}#P(){let e={},t=this,s={get(r,i){return typeof i=="string"?t.getItem(i):null},set(r,i,l){return t.setItems({[i]:l}),!0},ownKeys(r){return t.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,i){return typeof i=="string"&&t.deleteItem(i),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#l[e]=t,!0):!1}isSealed(){return this.#u}seal(){this.#u=!0}unseal(){this.#u=!1}#i(e,t){this.#f.push([e,t])}#o(){if(!this.#n){this.#n=!0;for(var e=0;e<this.#f.length;){let t=this.#f[e];this.#r.emit(t[0],t[1],this),e++}this.#f=[],this.#n=!1,this.#r.emit("#reactions_finished",this)}}setDebounceTime(e){this.#m=e<0?0:e}next(e){this.#n?this.#r.once("#reactions_finished",e):e(this)}#w(){for(;this.hasItem("_"+this.#v);)this.#v++;return"_"+this.#v}createAtom(e,t){return typeof t>"u"&&(t=this.#w()),new d(this,t,e)}getAtom(e){return this.isAtomItem(e)?new d(this,e):!1}createComputed(e,t){return typeof t>"u"&&(t=this.#w()),new p(this,t,e)}getComputed(e){return this.isComputedItem(e)?new p(this,e):!1}createCollection(e,t){return typeof t>"u"&&(t=this.#w()),new g(this,t,e)}getCollection(e){return this.isCollection(e)?new g(this,e):!1}};function M(u){return new I(u)}export{b as EventEmitter,I as Store,c as UpdateEventDetails,M as createStore,w as debounce};
