// version 1.0.6
var b=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,r,n=[].slice.call(arguments,1);for(s=this.events[e].slice(),r=s.length,t=0;t<r;t++)try{s[t].apply(this,n)}catch(i){console.error(e,n),console.error(i)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};var d=class{#e;#t;constructor(e,t,s){this.#t=e,this.#e=t,typeof s<"u"&&(this.value=s)}set value(e){this.#t.setItem(this.#e,e)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(e,t){this.#t.subscribe(this.#e,e,t)}clearSubscribers(){this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){this.#t.hasSubscribers(this.#e)}setCompareFunction(e){return this.#t.setCompareFunction(this.#e,e)}get store(){return this.#t}};var g=class{#e;#t;#s;constructor(e,t,s){this.#t=e,this.#e=t,typeof s<"u"&&(this.#s=this.#t.createCollectionItem(this.#e,s))}set value(e){this.#s=e,this.#t.setItem(this.#e,e)}get value(){return this.#s}get name(){return this.#e}subscribe(e,t){this.#t.subscribe(this.#e,e,t)}clearSubscribers(){this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){this.#t.hasSubscribers(this.#e)}setCompareFunction(e){return this.#t.setCompareFunction(this.#e,e)}};var p=class{#e;#t;constructor(e,t,s){this.#t=e,this.#e=t,typeof s<"u"&&this.#t.createComputedItem(this.#e,s)}get value(){return this.#t.getItem(this.#e)}get name(){return this.#e}subscribe(e,t){this.#t.subscribe(this.#e,e,t)}clearSubscribers(){this.#t.clearItemSubscribers(this.#e)}hasSubscribers(){this.#t.hasSubscribers(this.#e)}setCompareFunction(e){return this.#t.setCompareFunction(this.#e,e)}recalc(){return this.#t.recalcComputed(this.#e)}};function v(o,e){if(o===e)return!0;if(o===null||e===null||o===void 0||e===void 0||typeof o!=typeof e)return!1;if(Array.isArray(o)||Array.isArray(e))return JSON.stringify(o)===JSON.stringify(e);let t=JSON.stringify(o,Object.keys(o).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function m(o,e){var t;return function(){var s=this,r=arguments,n=function(){t=null,o.apply(s,r)};clearTimeout(t),t=setTimeout(n,e)}}var c=class{value;old_value;item_name;eventType;property=null},y=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,w=class{#e=new Map;#t=new Map;#s=new Map;#p=null;#n={};#o=!1;#l=!1;#f=[];#m=0;#r=new b;#c=!1;#a=new Set;#b=0;log=console.log;logError=console.error;warn=console.warn;constructor(e){e&&this.setItems(e)}#v(e){return y.test(e)}#x(e,t){let s=this.#e.get(e);this.#e.set(e,t);let r=!0;if(this.#n[e]?r=this.#n[e](s,t,e,null):r=v(s,t),!r){let n=new c;return n.eventType="set",n.item_name=e,n.value=t,n.old_value=s,n}return!1}#$(e,t){if(!this.#v(e))throw new Error(`${e} is wrong store's item_name`);this.#e.set(e,t)}#I(e,t,s){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let r=this.#s.get(e),n=r[t],i=!0;if(this.#n[e]?(i=this.#n[e](n,s,e,t),this.log(i,n,s,e,t)):i=v(n,s),i)return!1;r[t]=s;let l=new c;return l.eventType="set",l.item_name=e,l.property=t,l.value=s,l.old_value=n,l}#y(e,t){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");t=t.toString();let s=this.#s.get(e),r=s[t];delete s[t];let n=new c;return n.eventType="delete",n.item_name=e,n.property=t,n.value=null,n.old_value=r,n}#O(e,t){let s=this.#s.get(e),r=!0,n=[],i=s.length;if(s.length>t.length)for(let h=t.length;h<s.length;h++){let u=this.#y(e,h.toString());u&&(n.push(u),r=!1)}s.length=t.length;for(let h=0;h<t.length;h++){let u=this.#I(e,h.toString(),t[h]);u&&(n.push(u),r=!1)}if(r)return!1;let l=new c;if(l.eventType="set",l.item_name=e,l.value=t,i!=t.length){let h=new c;h.eventType="set",h.item_name=e,h.property="length",h.value=t.length,h.old_value=i,store.#i(e,h),store.#h({[e]:h},"set"),store.#d(new Set(e),!1)}return{main_details:l,details_arr:n}}hasItem(e){return this.#e.has(e)||this.#t.has(e)||this.#s.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}#d(e,t=!0){var s={};this.#t.forEach(r=>{if(!this.#C(r,e)||!this.hasSubscribers(r.item_name))return;let i=this.#g(r.item_name);i!==!1&&(this.#i(i.item_name,i),s[r.item_name]=i)}),Object.keys(s).length>0&&(this.#h(s,"set"),t&&this.#u())}setItems(e){if(this.#l)throw new Error("You cannot change property values \u200B\u200Bwhile reactions are running. Use method next() in reaction");var t={},s=[],r=!1,n=new Set;for(let i in e){if(i=="store"||this.isComputedItem(i))continue;if(!this.hasItem(i)){if(this.#o){this.logError(`Store is sealed. Can't create the item "${i}"`);continue}this.#$(i,void 0)}let l=e[i],h=this.isAtomItem(i),u=this.isCollection(i);if(h){let a=this.#x(i,l);if(a==!1)continue;r=!0,t[i]=a,s.push(a),n.add(i)}if(u){let a=this.#O(i,l);if(a==!1)continue;r=!0;let{main_details:f,details_arr:I}=a;t[i]=f,s.push(...I,f),n.add(i)}}if(r){this.#t.forEach(i=>{if(!this.#C(i,n)||!this.hasSubscribers(i.item_name))return;let h=this.#g(i.item_name);h!==!1&&(t[i.item_name]=h,s.push(h))});for(let i=0;i<s.length;i++){let l=s[i];this.#i(l.item_name,l)}this.#h(t,"set"),this.#u()}}isComputedItem(e){return this.#t.has(e)}isAtomItem(e){return this.#e.has(e)}isCollection(e){return this.#s.has(e)}#g(e){let t=this.#t.get(e),s=this,r=t.value;t.stale=!0;let n=t.getter();t.stale=!1;let i=!0;if(this.#n[e]?i=this.#n[e](r,n,e,null):i=v(r,n),i)return!1;t.value=n;let l=new c;return l.eventType="set",l.item_name=e,l.value=n,l.old_value=r,l}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#g(e);return t&&this.hasSubscribers(e)&&(this.#i(e,t),this.#u()),t}#j(e,t){let s=this;var r=()=>{try{return t(s)}catch(l){return this.logError(`Computed error ${e}: `,l),"#ERROR!"}};this.#a.clear(),this.#c=!0;let n=r();var i=Array.from(this.#a);if(i.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);this.#c=!1,this.#a.clear(),this.#t.set(e,{item_name:e,dependencies:i,getter:r,value:n,stale:!1})}#C(e,t){for(var s=e.dependencies,r=0;r<s.length;r++)if(t.has(s[r]))return e.stale=!0,!0;return!1}#S(e,t,s=!1){if(e=e.trim(),this.hasItem(e))return this.warn(`Item name ${e} name already exists`),!1;if(!s&&!this.#v(e))throw new Error(`${e} is wrong store's item_name`);return this.#j(e,t),!0}createComputedItem(e,t){return this.#o?(this.logError(`Store is sealed. Can't create the item "${e}"`),!1):this.#S(e,t)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,r=e,n=r.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let u of n){let a=u[0].slice(1);this.hasItem(a)&&s.add(a)}var i=Array.from(s),l=i.map(u=>`var $${u} = store.getItem("${u}");`).join(`
`),h=new Function("store",`
    ${l}
    return ${e};
`);return this.#S(t,h,i,!0),t}createCollectionItem(e,t){e=e.trim();var s=t.length;if(this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#v(e))throw new Error(`${e} is wrong store's item_name`);var r=this,n=new Proxy(t,{deleteProperty:function(i,l){let h=i.length;if(typeof l=="symbol")delete i[l];else if(typeof l=="string"){let u=r.#y(e,l);u&&(delete i[l],r.#i(u.item_name,u),r.#h({[e]:u},"delete"),r.#d(new Set(e)),r.#u())}return!0},set:function(i,l,h,u){if(typeof l=="symbol")i[l]=h;else if(typeof l=="string"){let a=r.#I(e,l,h);if(a){if(i[l]=h,s!=i.length){let f=new c;f.eventType="set",f.item_name=e,f.property="length",f.value=i.length,f.old_value=s,s=i.length,r.#i(e,f),r.#h({[e]:f},"set"),r.#d(new Set(e)),r.#u()}r.#i(a.item_name,a),r.#h({[e]:a},"set"),r.#d(new Set(e)),r.#u()}}return!0}});return r.#s.set(e,t),n}onChange(e){return this.#r.on("#change",e)}onChangeAny(e,t){if(e.length==0)return;let s=this;return this.#r.on("#change",function(n){let i=n.details,l=!1;for(let h in i)if(e.indexOf(h)>-1){l=!0;break}l&&t(n,s)})}deleteItem(e){if(this.#o)return this.logError(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new c;s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#t.delete(e),this.isAtomItem(e)&&this.#e.delete(e),this.isCollection(e)&&this.#s.delete(e),this.#h({[e]:s},"delete")}#A(){return Object.fromEntries(this.#e)}getItems(e=!1){return e?Object.assign({},this.#A(),this.#T()):this.#A()}#E(e){return this.#t.get(e).stale&&this.#g(e),this.#t.get(e).value}#k(e){return this.#c&&this.#a.add(e),this.#s.get(e)}#T(){let e={};return this.#t.forEach(t=>{e[t.item_name]=this.#E(t.item_name)}),e}#F(e){return this.#c&&this.#a.add(e),this.#e.get(e)}getItem(e){if(e=="store")return this;if(!this.hasItem(e))return null;if(this.isAtomItem(e))return this.#F(e);if(this.isComputedItem(e))return this.#E(e);if(this.isCollection(e))return this.#k(e)}getItemNames(){return[].concat(Array.from(this.#e.keys()),Array.from(this.#t.keys()),Array.from(this.#s.keys()))}subscribe(e,t,s){s===void 0&&(s=this.#m);var r=s<=0?t:m(t,s);return this.#r.on(e,r)}hasSubscribers(e){let t=this.#r.events[e];return t?t.length>0:!1}clearSubscribers(){this.#r.events={}}clearItemSubscribers(e){delete this.#r.events[e]}reset(){this.#e.clear(),this.#t.clear(),this.#s.clear(),this.clearSubscribers()}#h(e,t=null){let s={details:e,eventType:t};this.#i("#change",s)}asObject(){return this.#p||(this.#p=this.#N()),this.#p}#N(){let e={},t=this,s={get(r,n){return typeof n=="string"?t.getItem(n):null},set(r,n,i){return t.setItems({[n]:i}),!0},ownKeys(r){return t.getItemNames()},getOwnPropertyDescriptor(r){return{enumerable:!0,configurable:!0}},deleteProperty:function(r,n){return typeof n=="string"&&t.deleteItem(n),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#n[e]=t,!0):!1}isSealed(){return this.#o}seal(){this.#o=!0}unseal(){this.#o=!1}#i(e,t){this.#f.push([e,t])}#u(){if(!this.#l){this.#l=!0;for(var e=0;e<this.#f.length;){let t=this.#f[e];this.#r.emit(t[0],t[1],this),e++}this.#f=[],this.#l=!1,this.#r.emit("#reactions_finished",this)}}setDebounceTime(e){this.#m=e<0?0:e}next(e){this.#l?this.#r.once("#reactions_finished",e):e(this)}#w(){for(;this.hasItem("_"+this.#b);)this.#b++;return"_"+this.#b}createAtom(e,t){return typeof t>"u"&&(t=this.#w()),new d(this,t,e)}getAtom(e){return this.isAtomItem(e)?new d(this,e):!1}createComputed(e,t){return typeof t>"u"&&(t=this.#w()),new p(this,t,e)}getComputed(e){return this.isComputedItem(e)?new p(this,e):!1}createCollection(e,t){return typeof t>"u"&&(t=this.#w()),new g(this,t,e)}getCollection(e){return this.isCollection(e)?new g(this,e):!1}};function Z(o){return new w(o)}export{b as EventEmitter,w as Store,c as UpdateEventDetails,Z as createStore,m as debounce};
