// version 1.0.0
var c=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,n,i=[].slice.call(arguments,1);for(s=this.events[e].slice(),n=s.length,t=0;t<n;t++)try{s[t].apply(this,i)}catch(r){console.error(e,i),console.error(r)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};function d(o,e){if(o===e)return!0;if(o===null||e===null||o===void 0||e===void 0||typeof o!=typeof e)return!1;if(Array.isArray(o)||Array.isArray(e))return JSON.stringify(o)===JSON.stringify(e);let t=JSON.stringify(o,Object.keys(o).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function b(o,e){var t;return function(){var s=this,n=arguments,i=function(){t=null,o.apply(s,n)};clearTimeout(t),t=setTimeout(i,e)}}var f=class{value;old_value;item_name;eventType;property=null},p=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,g=class{#t=new Map;#e=new Map;#s=new Map;#h=null;#r={};#l=!1;#u=[];#c=0;#i=new c;constructor(e){e&&this.setItems(e)}log=console.log;#a(e){return p.test(e)}#p(e,t){let s=this.#t.get(e);this.#t.set(e,t);let n=!0;if(this.#r[e]?n=this.#r[e](s,t,e,null):n=d(s,t),!n){let i=new f;return i.eventType="set",i.item_name=e,i.value=t,i.old_value=s,i}return!1}#w(e,t){if(!this.#a(e))throw new Error(`${e} is wrong store's item_name`);this.#t.set(e,t)}#d(e,t,s){t=t.toString();let n=this.#s.get(e),i=n[t],r=!0;if(this.#r[e]?(r=this.#r[e](i,s,e,t),this.log(r,i,s,e,t)):r=d(i,s),r)return!1;n[t]=s;let l=new f;return l.eventType="set",l.item_name=e,l.property=t,l.value=s,l.old_value=i,l}#g(e,t){t=t.toString();let s=this.#s.get(e),n=s[t];if(!s.hasOwnProperty(t))return!1;delete s[t];let i=new f;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=n,i}#y(e,t){let s=this.#s.get(e),n=!0,i=[];if(s.length>t.length)for(let l=t.length;l<s.length;l++){let u=this.#g(e,l.toString());u&&(i.push(u),n=!1)}s.length=t.length;for(let l=0;l<t.length;l++){let u=this.#d(e,l.toString(),t[l]);u&&(i.push(u),n=!1)}if(n)return!1;let r=new f;return r.eventType="set",r.item_name=e,r.value=t,{main_details:r,details_arr:i}}hasItem(e){return this.#t.has(e)||this.#e.has(e)||this.#s.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}setItems(e){var t={},s=[],n=!1,i=new Set;for(let r in e){if(r=="store"||this.isComputedItem(r))continue;if(!this.hasItem(r)){if(this.#l){console.error(`Store is sealed. Can't create the item "${r}"`);continue}this.#w(r,void 0)}let l=e[r],u=this.isAtomItem(r),h=this.isCollection(r);if(u){let a=this.#p(r,l);if(a==!1)continue;n=!0,t[r]=a,s.push(a),i.add(r)}if(h){let a=this.#y(r,l);if(a==!1)continue;n=!0;let{main_details:v,details_arr:I}=a;t[r]=v,s.push(...I,v),i.add(r)}}if(n){this.#e.forEach(r=>{if(!this.#C(r,i)||!this.hasSubscribers(r.item_name))return;let u=this.#f(r.item_name);u!==!1&&(t[r.item_name]=u,s.push(u))});for(let r=0;r<s.length;r++){let l=s[r];this.#n(l.item_name,l)}this.#o(t,"set")}}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#t.has(e)}isCollection(e){return this.#s.has(e)}#f(e){let t=this.#e.get(e),s=this,n=t.value;t.stale=!0;let i=t.getter(s);t.stale=!1;let r=!0;if(this.#r[e]?r=this.#r[e](n,i,e,null):r=d(n,i),r)return!1;t.value=i;let l=new f;return l.eventType="set",l.item_name=e,l.value=i,l.old_value=n,l}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#f(e);return t&&this.hasSubscribers(e)&&this.#n(e,t),t}#m(e,t,s){let n=this;if(s.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);this.#e.set(e,{item_name:e,dependencies:s,getter:t,value:t(n),stale:!1})}#C(e,t){for(var s=e.dependencies,n=0;n<s.length;n++)if(t.has(s[n]))return e.stale=!0,!0;return!1}#v(e,t,s,n=!1){if(e=e.trim(),this.hasItem(e))return console.warn(`Item name ${e} name already exists`),!1;if(!n&&!this.#a(e))throw new Error(`${e} is wrong store's item_name`);let i=new Set;for(let r=0;r<s.length;r++){let l=s[r];if(!this.hasItem(l)){console.warn(`${e}: Unknown dependency ${l} is ignored`);continue}if(!this.isAtomItem(l)){console.warn(`${e}: The non-atom item ${l} is ignored`);continue}i.add(l)}return this.#m(e,t,Array.from(i)),!0}createComputedItem(e,t,s){return this.#l?(console.error(`Store is sealed. Can't create the item "${e}"`),!1):this.#v(e,t,s)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,n=e,i=n.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let h of i){let a=h[0].slice(1);this.hasItem(a)&&s.add(a)}var r=Array.from(s),l=r.map(h=>`var $${h} = store.getItem("${h}");`).join(`
`),u=new Function("store",`
    ${l}
    return ${e};
`);return this.#v(t,u,r,!0),t}createCollection(e,t){if(e=e.trim(),this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#a(e))throw new Error(`${e} is wrong store's item_name`);var s=this,n=new Proxy(t,{deleteProperty:function(i,r){if(typeof r=="symbol")delete i[r];else if(typeof r=="string"){let l=s.#g(e,r);l&&(delete i[r],s.#n(l.item_name,l),s.#o({[e]:l},"delete"))}return!0},set:function(i,r,l,u){if(typeof r=="symbol")i[r]=l;else if(typeof r=="string"){let h=s.#d(e,r,l);h&&(i[r]=l,s.#n(h.item_name,h),s.#o({[e]:h},"set"))}return!0}});return s.#s.set(e,t),n}onChange(e){return this.#i.on("change",e)}onChangeAny(e,t){if(e.length==0)return;let s=this;return this.#i.on("change",function(i){let r=i.details,l=!1;for(let u in r)if(e.indexOf(u)>-1){l=!0;break}l&&t(i,s)})}deleteItem(e){if(this.#l)return console.error(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new f;s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#t.delete(e),this.isCollection(e)&&this.#s.delete(e),this.#o({[e]:s},"delete")}#b(){return Object.fromEntries(this.#t)}getItems(e=!1){return e?Object.assign({},this.#b(),this.#S()):this.#b()}#I(e){return this.#e.get(e).stale&&this.#f(e),this.#e.get(e).value}#A(e){return this.#s.get(e)}#S(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#I(t.item_name)}),e}#$(e){return this.#t.get(e)}getItem(e){if(e=="store")return this;if(!this.hasItem(e))return null;if(this.isAtomItem(e))return this.#$(e);if(this.isComputedItem(e))return this.#I(e);if(this.isCollection(e))return this.#A(e)}getItemNames(){return[].concat(Array.from(this.#t.keys()),Array.from(this.#e.keys()),Array.from(this.#s.keys()))}subscribe(e,t,s){s===void 0&&(s=this.#c);var n=s<=0?t:b(t,s);return this.#i.on(e,n)}hasSubscribers(e){let t=this.#i.events[e];return t?t.length>0:!1}clearSubscribers(){this.#i.events={}}clearItemSubscribers(e){delete this.#i.events[e]}reset(){this.#t.clear(),this.#e.clear(),this.#s.clear(),this.clearSubscribers()}#o(e,t=null){let s={details:e,eventType:t};this.#n("change",s)}asObject(){return this.#h||(this.#h=this.#x()),this.#h}#x(){let e={},t=this,s={get(n,i){return typeof i=="string"?t.getItem(i):null},set(n,i,r){return t.setItems({[i]:r}),!0},ownKeys(n){return t.getItemNames()},getOwnPropertyDescriptor(n){return{enumerable:!0,configurable:!0}},deleteProperty:function(n,i){return typeof i=="string"&&t.deleteItem(i),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#r[e]=t,!0):!1}isSealed(){return this.#l}seal(){this.#l=!0}unseal(){this.#l=!1}#n(e,t){this.#u.push([e,t]),this.#O()}#O(){for(let e=0;e<this.#u.length;e++){let t=this.#u[e];this.#i.emit(t[0],t[1],this)}this.#u=[]}setDebounceTime(e){this.#c=e<0?0:e}};function A(o){return new g(o)}export{c as EventEmitter,g as Store,f as UpdateEventDetails,A as createStore,b as debounce};
