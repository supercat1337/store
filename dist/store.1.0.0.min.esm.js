// version 1.0.0
var c=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,n,i=[].slice.call(arguments,1);for(s=this.events[e].slice(),n=s.length,t=0;t<n;t++)try{s[t].apply(this,i)}catch(r){console.error(e,i),console.error(r)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};function d(u,e){if(u===e)return!0;if(u===null||e===null||u===void 0||e===void 0||typeof u!=typeof e)return!1;if(Array.isArray(u)||Array.isArray(e))return JSON.stringify(u)===JSON.stringify(e);let t=JSON.stringify(u,Object.keys(u).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}function I(u,e){var t;return function(){var s=this,n=arguments,i=function(){t=null,u.apply(s,n)};clearTimeout(t),t=setTimeout(i,e)}}var f=class{value;old_value;item_name;eventType;property=null},p=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,g=class{#s=new Map;#e=new Map;#r=new Map;#o=null;#i={};#l=!1;#t=new c;constructor(e){e&&this.setItems(e)}log=console.log;#u(e){return p.test(e)}#v(e,t){let s=this.#s.get(e);this.#s.set(e,t);let n=!0;if(this.#i[e]?n=this.#i[e](s,t,e,null):n=d(s,t),!n){let i=new f;return i.eventType="set",i.item_name=e,i.value=t,i.old_value=s,i}return!1}#b(e,t){if(!this.#u(e))throw new Error(`${e} is wrong store's item_name`);this.#s.set(e,t)}#a(e,t,s){t=t.toString();let n=this.#r.get(e),i=n[t],r=!0;if(this.#i[e]?(r=this.#i[e](i,s,e,t),this.log(r,i,s,e,t)):r=d(i,s),r)return!1;n[t]=s;let l=new f;return l.eventType="set",l.item_name=e,l.property=t,l.value=s,l.old_value=i,l}#f(e,t){t=t.toString();let s=this.#r.get(e),n=s[t];if(!s.hasOwnProperty(t))return!1;delete s[t];let i=new f;return i.eventType="delete",i.item_name=e,i.property=t,i.value=null,i.old_value=n,i}#I(e,t){let s=this.#r.get(e),n=!0,i=[];if(s.length>t.length)for(let l=t.length;l<s.length;l++){let o=this.#f(e,l.toString());o&&(i.push(o),n=!1)}s.length=t.length;for(let l=0;l<t.length;l++){let o=this.#a(e,l.toString(),t[l]);o&&(i.push(o),n=!1)}if(n)return!1;let r=new f;return r.eventType="set",r.item_name=e,r.value=t,{main_details:r,details_arr:i}}hasItem(e){return this.#s.has(e)||this.#e.has(e)||this.#r.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}setItems(e){var t={},s=[],n=!1,i=new Set;for(let r in e){if(r=="store"||this.isComputedItem(r))continue;if(!this.hasItem(r)){if(this.#l){console.error(`Store is sealed. Can't create the item "${r}"`);continue}this.#b(r,void 0)}let l=e[r],o=this.isAtomItem(r),h=this.isCollection(r);if(o){let a=this.#v(r,l);if(a==!1)continue;n=!0,t[r]=a,s.push(a),i.add(r)}if(h){let a=this.#I(r,l);if(a==!1)continue;n=!0;let{main_details:v,details_arr:b}=a;t[r]=v,s.push(...b,v),i.add(r)}}if(n){this.#e.forEach(r=>{if(!this.#m(r,i)||!this.hasSubscribers(r.item_name))return;let o=this.#h(r.item_name);o!==!1&&(t[r.item_name]=o,s.push(o))});for(let r=0;r<s.length;r++){let l=s[r];this.#t.emit(l.item_name,l,this)}this.#n(t,"set")}}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#s.has(e)}isCollection(e){return this.#r.has(e)}#h(e){let t=this.#e.get(e),s=this,n=t.value;t.stale=!0;let i=t.getter(s);t.stale=!1;let r=!0;if(this.#i[e]?r=this.#i[e](n,i,e,null):r=d(n,i),r)return!1;t.value=i;let l=new f;return l.eventType="set",l.item_name=e,l.value=i,l.old_value=n,l}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#h(e);return t&&this.hasSubscribers(e)&&this.#t.emit(e,t,this),t}#p(e,t,s){let n=this;if(s.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);this.#e.set(e,{item_name:e,dependencies:s,getter:t,value:t(n),stale:!1})}#m(e,t){for(var s=e.dependencies,n=0;n<s.length;n++)if(t.has(s[n]))return e.stale=!0,!0;return!1}#c(e,t,s,n=!1){if(e=e.trim(),this.hasItem(e))return console.warn(`Item name ${e} name already exists`),!1;if(!n&&!this.#u(e))throw new Error(`${e} is wrong store's item_name`);let i=new Set;for(let r=0;r<s.length;r++){let l=s[r];if(!this.hasItem(l)){console.warn(`${e}: Unknown dependency ${l} is ignored`);continue}if(!this.isAtomItem(l)){console.warn(`${e}: The non-atom item ${l} is ignored`);continue}i.add(l)}return this.#p(e,t,Array.from(i)),!0}createComputedItem(e,t,s){return this.#l?(console.error(`Store is sealed. Can't create the item "${e}"`),!1):this.#c(e,t,s)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,n=e,i=n.matchAll(/\$[a-zA-Z_][a-zA-Z0-9_]*/g);for(let h of i){let a=h[0].slice(1);this.hasItem(a)&&s.add(a)}var r=Array.from(s),l=r.map(h=>`var $${h} = store.getItem("${h}");`).join(`
`),o=new Function("store",`
    ${l}
    return ${e};
`);return this.#c(t,o,r,!0),t}createCollection(e,t){if(e=e.trim(),this.hasItem(e))throw new Error(`Item name ${e} name already exists`);if(!this.#u(e))throw new Error(`${e} is wrong store's item_name`);var s=this,n=new Proxy(t,{deleteProperty:function(i,r){if(typeof r=="symbol")delete i[r];else if(typeof r=="string"){let l=s.#f(e,r);l&&(delete i[r],s.#t.emit(l.item_name,l,s),s.#n({[e]:l},"delete"))}return!0},set:function(i,r,l,o){if(typeof r=="symbol")i[r]=l;else if(typeof r=="string"){let h=s.#a(e,r,l);h&&(i[r]=l,s.#t.emit(h.item_name,h,s),s.#n({[e]:h},"set"))}return!0}});return s.#r.set(e,t),n}onChange(e){return this.#t.on("change",e)}onChangeAny(e,t){if(e.length==0)return;let s=this;return this.#t.on("change",function(i){let r=i.details,l=!1;for(let o in r)if(e.indexOf(o)>-1){l=!0;break}l&&t(i,s)})}deleteItem(e){if(this.#l)return console.error(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new f;s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#s.delete(e),this.isCollection(e)&&this.#r.delete(e),this.#n({[e]:s},"delete")}#d(){return Object.fromEntries(this.#s)}getItems(e=!1){return e?Object.assign({},this.#d(),this.#y()):this.#d()}#g(e){return this.#e.get(e).stale&&this.#h(e),this.#e.get(e).value}#w(e){return this.#r.get(e)}#y(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#g(t.item_name)}),e}#C(e){return this.#s.get(e)}getItem(e){if(e=="store")return this;if(!this.hasItem(e))return null;if(this.isAtomItem(e))return this.#C(e);if(this.isComputedItem(e))return this.#g(e);if(this.isCollection(e))return this.#w(e)}getItemNames(){return[].concat(Array.from(this.#s.keys()),Array.from(this.#e.keys()),Array.from(this.#r.keys()))}subscribe(e,t){return this.#t.on(e,t)}hasSubscribers(e){let t=this.#t.events[e];return t?t.length>0:!1}clearSubscribers(){this.#t.events={}}clearItemSubscribers(e){delete this.#t.events[e]}reset(){this.#s.clear(),this.#e.clear(),this.#r.clear(),this.clearSubscribers()}#n(e,t=null){let s={details:e,eventType:t};this.#t.emit("change",s,this)}asObject(){return this.#o||(this.#o=this.#A()),this.#o}#A(){let e={},t=this,s={get(n,i){return typeof i=="string"?t.getItem(i):null},set(n,i,r){return t.setItems({[i]:r}),!0},ownKeys(n){return t.getItemNames()},getOwnPropertyDescriptor(n){return{enumerable:!0,configurable:!0}},deleteProperty:function(n,i){return typeof i=="string"&&t.deleteItem(i),!0}};return new Proxy(e,s)}setCompareFunction(e,t){return this.hasItem(e)?(this.#i[e]=t,!0):!1}isSealed(){return this.#l}seal(){this.#l=!0}unseal(){this.#l=!1}};function A(u){return new g(u)}export{c as EventEmitter,g as Store,f as UpdateEventDetails,A as createStore,I as debounce};
