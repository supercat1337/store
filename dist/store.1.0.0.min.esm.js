var c=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let s=this;return function(){s.removeListener(e,t)}}removeListener(e,t){var s;typeof this.events[e]=="object"&&(s=this.events[e].indexOf(t),s>-1&&this.events[e].splice(s,1))}emit(e){if(typeof this.events[e]=="object"){var t,s,n,i=[].slice.call(arguments,1);for(s=this.events[e].slice(),n=s.length,t=0;t<n;t++)try{s[t].apply(this,i)}catch(r){console.error(e,i),console.error(r)}}}once(e,t){return this.on(e,function s(){this.removeListener(e,s),t.apply(this,arguments)})}};function d(u,e){if(u===e)return!0;if(typeof u!=typeof e)return!1;if(Array.isArray(u)||Array.isArray(e))return JSON.stringify(u)===JSON.stringify(e);if(u===null||e===null||u===void 0||e===void 0)return!1;let t=JSON.stringify(u,Object.keys(u).sort()),s=JSON.stringify(e,Object.keys(e).sort());return t===s}var f=class{value;old_value;item_name;eventType;property=null},p=/^([a-zA-Z_][a-zA-Z0-9_]*)$/,m=/\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g,g=class{#s=new Map;#e=new Map;#r=new Map;#o=null;#i=null;#n=!1;#t=new c;constructor(e){e&&this.setItems(e)}#u(e){return p.test(e)}#g(e,t){let s=this.#s.get(e);this.#s.set(e,t);let n=!0;if(this.#i?n=this.#i(s,t,e,this):n=d(s,t),!n){let i=new f;return i.eventType="set",i.item_name=e,i.value=t,i.old_value=s,i}return!1}#p(e,t){if(!this.#u(e))throw new Error(`${e} is wrong store's item_name`);this.#s.set(e,t)}#a(e,t,s){t=t.toString();let i=this.#r.get(e)[t],r=!0;if(this.#i?r=this.#i(i,s,e,this):r=d(i,s),!r){let l=/^\d+$/.test(t)?parseInt(t):t,o=new f;return o.eventType="set",o.item_name=e,o.property=l,o.value=s,o.old_value=i,o}return!1}#m(e,t){let s=this.#r.get(e),n=!0;s.length=t.length;for(let i=0;i<s.length;i++)this.#a(e,i,t)&&(n=!1);if(!n){let i=new f;return i.eventType="set",i.item_name=e,i.value=t,i}return!1}hasItem(e){return this.#s.has(e)||this.#e.has(e)||this.#r.has(e)}setItem(e,t){var s={[e]:t};this.setItems(s)}setItems(e){var t={},s=[],n=!1,i=new Set;for(let r in e){if(r=="store"||this.isComputedItem(r))continue;if(!this.hasItem(r)){if(this.#n){console.error(`Store is sealed. Can't create the item "${r}"`);continue}this.#p(r,void 0)}let l=e[r],o=this.isAtomItem(r),h=this.isCollection(r);if(o||h){let a=o?this.#g(r,l):this.#m(r,l);if(a==!1)continue;n=!0,t[r]=a,s.push(a),i.add(r)}}if(n){this.#e.forEach(r=>{if(!this.#b(r,i)||!this.hasSubscribers(r.item_name))return;let o=this.#h(r.item_name);o&&(t[r.item_name]=o,s.push(o))});for(let r=0;r<s.length;r++){let l=s[r];this.#t.emit(l.item_name,l,this)}this.#l(t,"set")}}isComputedItem(e){return this.#e.has(e)}isAtomItem(e){return this.#s.has(e)}isCollection(e){return this.#r.has(e)}#h(e){let t=this.#e.get(e),s=this,n=t.value;t.stale=!0;let i=t.getter(s);t.stale=!1;let r=!0;if(this.#i?r=this.#i(n,i,e,this):r=d(n,i),r)return!1;t.value=i;let l=new f;return l.eventType="set",l.item_name=e,l.value=i,l.old_value=n,l}recalcComputed(e){if(!this.isComputedItem(e))return!1;let t=this.#h(e);return t&&this.hasSubscribers(e)&&this.#t.emit(e,t,this),t}#v(e,t,s){let n=this;if(s.length==0)throw new Error(`Computed item ${e} hasn't dependencies`);this.#e.set(e,{item_name:e,dependencies:s,getter:t,value:t(n),stale:!1})}#b(e,t){for(var s=e.dependencies,n=0;n<s.length;n++)if(t.has(s[n]))return e.stale=!0,!0;return!1}#f(e,t,s,n=!1){if(e=e.trim(),this.hasItem(e)){console.warn(`Item name ${e} name already exists`);return}if(!n&&!this.#u(e))throw new Error(`${e} is wrong store's item_name`);let i=new Set;for(let r=0;r<s.length;r++){let l=s[r];if(!this.hasItem(l)){console.warn(`${e}: Unknown dependency ${l} is ignored`);continue}if(!this.isAtomItem(l)){console.warn(`${e}: The non-atom item ${l} is ignored`);continue}i.add(l)}this.#v(e,t,Array.from(i))}createComputedItem(e,t,s){if(this.#n)return console.error(`Store is sealed. Can't create the item "${e}"`),!1;this.#f(e,t,s)}loadExpression(e){e=e.trim();let t=`{${e}}`;if(this.hasItem(t))return t;var s=new Set,n=e;n=n.replace(/\.\s*[a-zA-Z_][a-zA-Z0-9_]*/g,"");var i=n.matchAll(m);for(let h of i)/\b(this|store)\b/.test(h[0])||this.hasItem(h[0])&&s.add(h[0]);var r=Array.from(s),l=r.map(h=>`var ${h} = store.getItem("${h}");`).join(`
`),o=new Function("store",`
    ${l}
    return ${e};
`);return this.#f(t,o,r,!0),t}createCollection(e,t){if(e=e.trim(),this.hasItem(e)){console.warn(`Item name ${e} name already exists`);return}if(!this.#u(e))throw new Error(`${e} is wrong store's item_name`);var s=this,n=new Proxy(t,{deleteProperty:function(i,r){if(typeof r=="string"){let l=new f;l.eventType="delete",l.item_name=e,l.value=i[r],l.property=r,delete i[r],s.#t.emit(l.item_name,l,s),s.#l({[e]:l},"delete")}else delete i[r];return!0},set:function(i,r,l,o){if(typeof r=="string"){let h=/^\d+$/.test(r)?parseInt(r):r,a=s.#a(e,h,l);i[r]=l,a&&(s.#t.emit(a.item_name,a,s),s.#l({[e]:a},"delete"))}else i[r]=l;return!0}});return n}onChange(e){return this.#t.on("change",e)}onChangeAny(e,t){if(e.length==0)return;let s=this;return this.#t.on("change",function(i){let r=i.details,l=!1;for(let o in r)if(e.indexOf(o)>-1){l=!0;break}l&&t(i,s)})}deleteItem(e){if(this.#n)return console.error(`Store is sealed. Can't delete the item "${e}"`),!1;if(!this.hasItem(e))return!1;let t=this.getItem(e),s=new f;s.eventType="delete",s.item_name=e,s.value=t,this.clearItemSubscribers(e),this.isComputedItem(e)&&this.#e.delete(e),this.isAtomItem(e)&&this.#s.delete(e),this.isCollection(e)&&this.#r.delete(e),this.#l({[e]:s},"delete")}getStateCopy(){return JSON.parse(JSON.stringify(this.getItems()))}#c(){return Object.fromEntries(this.#s)}getItems(e=!1){return e?Object.assign({},this.#c(),this.#y()):this.#c()}#d(e){return this.#e.get(e).stale&&this.#h(e),this.#e.get(e).value}#I(e){return this.#r.get(e)}#y(){let e={};return this.#e.forEach(t=>{e[t.item_name]=this.#d(t.item_name)}),e}#w(e){return this.#s.get(e)}getItem(e){return e=="store"?this:this.hasItem(e)?this.isAtomItem(e)?this.#w(e):this.isComputedItem(e)?this.#d(e):this.isCollection(e)?this.#I(e):null:null}getItemNames(){return[].concat(Array.from(this.#s.keys()),Array.from(this.#e.keys()),Array.from(this.#r.keys()))}subscribe(e,t){return this.#t.on(e,t)}hasSubscribers(e){let t=this.#t.events[e];return t?t.length>0:!1}clearSubscribers(){this.#t.events={}}clearItemSubscribers(e){delete this.#t.events[e]}reset(){this.#s.clear(),this.#e.clear(),this.clearSubscribers()}#l(e,t=null){let s={details:e,eventType:t};this.#t.emit("change",s,this)}asObject(){return this.#o||(this.#o=this.#C()),this.#o}#C(){let e={},t=this,s={get(n,i){if(typeof i=="string")return t.getItem(i)},set(n,i,r){return t.setItems({[i]:r}),!0},ownKeys(n){return t.getItemNames()},getOwnPropertyDescriptor(n){return{enumerable:!0,configurable:!0}},deleteProperty:function(n,i){return typeof i=="string"?t.deleteItem(i):!0}};return new Proxy(e,s)}setCompareFunction(e){this.#i=e}isSealed(){return this.#n}seal(){this.#n=!0}unseal(){this.#n=!1}};function A(u){return new g(u)}export{c as EventEmitter,g as Store,f as UpdateEventDetails,A as createStore};
